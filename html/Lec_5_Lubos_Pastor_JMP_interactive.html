<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lec 5 Lubos_Pastor_JMP - Interactive Learning</title>
    
    <!-- KaTeX for formula rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    
    <!-- Mermaid for flowcharts and diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    
    <!-- Fonts: Noto Serif for body, Inter for headings -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        
        :root {
            /* Warm Academic Theme - Clean & Readable */
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #1f2b47;
            --bg-elevated: #263352;
            --bg-card: #1c2a45;
            
            --text-primary: #edf2f7;
            --text-secondary: #a0aec0;
            --text-tertiary: #718096;
            
            /* Warm Gold + Sage Green palette */
            --accent-primary: #f6c177;
            --accent-secondary: #a3d9a5;
            --accent-tertiary: #c4b5fd;
            --accent-warning: #fbbf24;
            --accent-error: #fb7185;
            --accent-info: #7dd3fc;
            
            --gradient-primary: linear-gradient(135deg, #f6c177 0%, #e8a87c 100%);
            --gradient-heading: linear-gradient(135deg, #f6c177 0%, #c4b5fd 100%);
            
            --border-color: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(246, 193, 119, 0.25);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.25);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
            
            --font-body: 'Georgia', 'Times New Roman', 'Noto Serif SC', serif;
            --font-heading: -apple-system, 'Helvetica Neue', 'PingFang SC', sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', monospace;
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            --ease: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #faf8f5;
                --bg-secondary: #f0ece4;
                --bg-tertiary: #e8e2d8;
                --bg-elevated: #ffffff;
                --bg-card: #ffffff;
                
                --text-primary: #1c1917;
                --text-secondary: #57534e;
                --text-tertiary: #a8a29e;
                
                --accent-primary: #c2742f;
                --accent-secondary: #3d8b40;
                --accent-tertiary: #7c3aed;
                --accent-warning: #b45309;
                --accent-error: #dc2626;
                
                --gradient-heading: linear-gradient(135deg, #c2742f 0%, #7c3aed 100%);
                
                --border-color: rgba(0, 0, 0, 0.06);
                --border-hover: rgba(194, 116, 47, 0.3);
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.06);
                --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
                --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.8;
            overflow-x: hidden;
        }
        
        .page-container {
            --left-width: 260px;
            --right-width: 300px;
            display: grid;
            grid-template-columns: minmax(200px, var(--left-width)) 8px minmax(0, 1fr) 8px minmax(220px, var(--right-width));
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .column-resizer {
            cursor: col-resize;
            background: transparent;
            transition: background-color 0.15s var(--ease);
            position: sticky;
            top: 0;
            height: 100vh;
            z-index: 5;
        }
        .column-resizer:hover,
        .column-resizer.dragging {
            background: rgba(246, 193, 119, 0.2);
        }
        
        .sidebar-left, .sidebar-right {
            background: var(--bg-secondary);
            padding: 2rem 1.25rem;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-left {
            border-right: 1px solid var(--border-color);
        }
        
        .sidebar-right {
            border-left: 1px solid var(--border-color);
        }
        
        .main-content {
            max-width: none;
            min-width: 0;
            width: 100%;
            margin: 0 auto;
            padding: 3rem 2.5rem;
        }
        
        @media (max-width: 1200px) {
            .page-container { grid-template-columns: 1fr; }
            .sidebar-left, .sidebar-right, .column-resizer { display: none; }
            .main-content { padding: 2rem 1.25rem; }
        }
        
        h1 {
            font-family: var(--font-heading);
            font-size: clamp(1.875rem, 4vw, 2.5rem);
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 0.75rem;
            letter-spacing: -0.01em;
            color: var(--text-primary);
        }
        
        h2 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 3.5rem;
            margin-bottom: 1.25rem;
            color: var(--accent-primary);
            letter-spacing: -0.01em;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        h3 {
            font-family: var(--font-heading);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        
        h4 {
            font-family: var(--font-heading);
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.8;
        }
        
        .feynman-block {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-primary);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 1.5rem 0;
            transition: border-color 0.2s var(--ease);
        }
        
        .feynman-block:hover {
            border-color: var(--border-hover);
        }
        
        .feynman-block .icon {
            font-size: 1.75rem;
            margin-bottom: 0.75rem;
            display: inline-block;
        }
        
        .expandable {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin: 1.5rem 0;
            overflow: hidden;
        }
        
        .expandable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            cursor: pointer;
            user-select: none;
            font-weight: 500;
            font-family: var(--font-heading);
            transition: background 0.15s var(--ease);
        }
        
        .expandable-header:hover {
            background: var(--bg-tertiary);
        }
        
        .expandable-icon {
            transition: transform 0.25s var(--ease);
            display: inline-block;
            font-size: 0.8rem;
        }
        
        .expandable.open .expandable-icon {
            transform: rotate(180deg);
        }
        
        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s var(--ease);
        }
        
        .expandable.open .expandable-content {
            max-height: 5000px;
        }
        
        .expandable-content-inner {
            padding: 1.25rem;
            border-top: 1px solid var(--border-color);
        }
        
        .quiz-container {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 2rem 0;
            border: 1px solid var(--border-color);
        }
        
        .quiz-question {
            font-size: 1.05rem;
            font-family: var(--font-heading);
            margin-bottom: 1.25rem;
            color: var(--text-primary);
        }
        
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }
        
        .quiz-option {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.15s var(--ease);
            font-size: 0.95rem;
        }
        
        .quiz-option:hover {
            border-color: var(--accent-primary);
            padding-left: 1.25rem;
        }
        
        .quiz-option.correct {
            background: rgba(163, 217, 165, 0.2);
            border-color: var(--accent-secondary);
            color: var(--accent-secondary);
        }
        
        .quiz-option.incorrect {
            background: rgba(251, 113, 133, 0.15);
            border-color: var(--accent-error);
            color: var(--accent-error);
        }
        
        .quiz-feedback {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            display: none;
            font-size: 0.9rem;
        }
        
        .quiz-feedback.show { display: block; }
        .quiz-feedback.correct { background: rgba(163, 217, 165, 0.15); border: 1px solid var(--accent-secondary); }
        .quiz-feedback.incorrect { background: rgba(251, 113, 133, 0.1); border: 1px solid var(--accent-error); }
        
        .progress-tracker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--bg-secondary);
            z-index: 1000;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.2s var(--ease);
        }
        
        .ai-chat {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.25rem;
        }
        
        .ai-chat-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .ai-chat-messages {
            max-height: 320px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }
        
        .ai-message {
            margin-bottom: 0.75rem;
            padding: 0.625rem 0.875rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            line-height: 1.6;
        }
        
        .ai-message.user {
            background: var(--accent-primary);
            color: var(--bg-primary);
            margin-left: 1.5rem;
            font-weight: 500;
        }
        
        .ai-message.assistant {
            background: var(--bg-tertiary);
            margin-right: 1.5rem;
        }
        
        .ai-input-group { display: flex; gap: 0.5rem; }
        
        .ai-input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.625rem 0.75rem;
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.875rem;
        }
        
        .ai-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        .ai-send-btn, .action-btn {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.625rem 1rem;
            cursor: pointer;
            font-weight: 600;
            font-family: var(--font-heading);
            font-size: 0.85rem;
            transition: opacity 0.15s;
        }
        
        .action-btn {
            width: 100%;
            margin-bottom: 0.5rem;
            text-align: left;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        
        .ai-send-btn:hover { opacity: 0.85; }
        .action-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        
        kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.15rem 0.5rem;
            font-family: var(--font-mono);
            font-size: 0.8em;
        }
        
        .toc-link {
            color: var(--text-secondary);
            text-decoration: none;
            display: block;
            padding: 0.375rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: var(--font-heading);
            transition: color 0.15s, background 0.15s;
        }
        
        .toc-link:hover {
            color: var(--accent-primary);
            background: var(--bg-tertiary);
        }
        
        /* Scroll reveal - simple fade */
        .reveal-on-scroll {
            opacity: 0;
            transform: translateY(16px);
            transition: opacity 0.5s var(--ease), transform 0.5s var(--ease);
        }
        .reveal-on-scroll.revealed {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }
        
        ::selection { background: var(--accent-primary); color: var(--bg-primary); }
        
        /* Print */
        @media print {
            .sidebar-left, .sidebar-right, .progress-tracker { display: none; }
            .page-container { grid-template-columns: 1fr; }
            body { background: white; color: black; }
        }
        
        /* ===========================================
           DATA VISUALIZATION & CHARTS
           =========================================== */
        .chart-container {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        .chart-container .chart-title {
            font-family: var(--font-heading);
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            text-align: center;
        }
        .chart-container canvas { max-height: 380px; width: 100% !important; }
        .chart-caption {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            text-align: center;
            margin-top: 0.75rem;
            font-style: italic;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .chart-grid .chart-container { margin: 0; }
        
        .diagram-container {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow-x: auto;
            text-align: center;
        }
        .diagram-container .diagram-title {
            font-family: var(--font-heading);
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }
        .diagram-container .mermaid { display: flex; justify-content: center; }
        .diagram-container .mermaid svg { max-width: 100%; height: auto; }
        .diagram-caption {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            text-align: center;
            margin-top: 0.75rem;
            font-style: italic;
        }
        
        .comparison-block {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: stretch;
            margin: 2rem 0;
        }
        .comparison-side {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .comparison-side.left { border-top: 3px solid var(--accent-primary); }
        .comparison-side.right { border-top: 3px solid var(--accent-secondary); }
        .comparison-side h4 { margin-bottom: 0.75rem; }
        .comparison-side ul { padding-left: 1.25rem; }
        .comparison-side li { margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.95rem; }
        .comparison-divider {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            color: var(--text-tertiary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.15s var(--ease);
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-primary);
            display: block;
            font-family: var(--font-heading);
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }
        
        @media (max-width: 768px) {
            .comparison-block { grid-template-columns: 1fr; }
            .comparison-divider { justify-content: center; padding: 0.5rem 0; }
            .chart-grid { grid-template-columns: 1fr; }
        }
        
        /* ===========================================
           SIDEBAR TABS & PANELS
           =========================================== */
        .sidebar-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 1rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            padding: 2px;
        }
        .sidebar-tab {
            flex: 1;
            padding: 0.5rem 0.25rem;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-family: var(--font-heading);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s var(--ease);
        }
        .sidebar-tab:hover { color: var(--text-secondary); }
        .sidebar-tab.active {
            background: var(--bg-elevated);
            color: var(--accent-primary);
        }
        
        /* ===========================================
           NOTES SYSTEM
           =========================================== */
        .note-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.625rem;
            font-size: 0.85rem;
            position: relative;
            cursor: pointer;
            transition: border-color 0.15s var(--ease), transform 0.15s var(--ease);
        }
        .note-card:hover { border-color: var(--border-hover); }
        .note-card.active {
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }
        .note-card.focused {
            border-left: 3px solid var(--accent-secondary);
            padding-left: calc(0.625rem - 2px);
        }
        .note-card .note-citation {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            border-left: 2px solid var(--accent-primary);
            padding-left: 0.5rem;
            margin-bottom: 0.375rem;
            font-style: italic;
            line-height: 1.4;
        }
        .note-card .note-body {
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .note-card .note-meta {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            margin-top: 0.375rem;
            display: flex;
            justify-content: space-between;
        }
        .note-card .note-delete {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0;
        }
        .note-card .note-delete:hover { color: var(--accent-error); }
        .note-card .note-focus {
            background: none;
            border: none;
            color: var(--accent-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0;
            margin-right: 0.5rem;
        }
        .note-card .note-focus:hover { color: var(--accent-primary); }
        .note-reader {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            overflow-y: auto;
            max-height: 34vh;
        }
        .note-reader .reader-title {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
        }
        .note-reader .reader-content {
            color: var(--text-secondary);
            line-height: 1.65;
            font-size: 0.9rem;
        }
        .note-reader .reader-content code {
            background: var(--bg-tertiary);
            padding: 0.1em 0.35em;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .note-draft-preview {
            margin-top: 0.5rem;
            max-height: 20vh;
        }
        
        /* ===========================================
           TEXT HIGHLIGHT
           =========================================== */
        .text-highlight {
            background: rgba(246, 193, 119, 0.25);
            border-bottom: 2px solid var(--accent-primary);
            cursor: pointer;
            transition: background 0.15s;
        }
        .text-highlight:hover {
            background: rgba(246, 193, 119, 0.4);
        }
        
        /* Highlight context menu */
        .highlight-tooltip {
            position: fixed;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            padding: 0.25rem;
            display: none;
            z-index: 1001;
            gap: 2px;
        }
        .highlight-tooltip.show { display: flex; }
        .highlight-tooltip button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.375rem 0.625rem;
            cursor: pointer;
            font-size: 0.8rem;
            font-family: var(--font-heading);
            border-radius: 4px;
            white-space: nowrap;
        }
        .highlight-tooltip button:hover {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
        }
    
    </style>
    <link rel="stylesheet" href="./app-shell.css?v=12" />
</head>
<body data-shell-page="lecture">
    <!-- Progress Tracker -->
    <div class="progress-tracker">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="page-container">
        <!-- Left Sidebar -->
        <aside class="sidebar-left">
            <!-- Sidebar Tabs -->
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="toc" onclick="switchSidebarTab('toc')">Contents</button>
                <button class="sidebar-tab" data-tab="pdf" onclick="switchSidebarTab('pdf')">PDF</button>
                <button class="sidebar-tab" data-tab="notes" onclick="switchSidebarTab('notes')">Notes</button>
            </div>
            
            <!-- Tab: Table of Contents -->
            <div class="sidebar-panel" id="panel-toc">
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 0.75rem;">
                        <a href="#overview" class="toc-link">Overview</a>
                    </li>
                    
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-1" class="toc-link">Bayesian Portfolio Selection</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-2" class="toc-link">Asset Pricing Models</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-3" class="toc-link">Prior Beliefs</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-4" class="toc-link">Model-based vs. Data-based Approaches</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-5" class="toc-link">Home Bias</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-6" class="toc-link">Mean-Variance Framework</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-7" class="toc-link">Priced Sources of Risk</a>
            </li>
        
                </ul>
                
                <div style="margin-top: 3rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.85rem;">
                    <div style="color: var(--text-tertiary); margin-bottom: 0.5rem;">Course Stats</div>
                    <div style="color: var(--text-secondary);">
                        <div>7 Concepts</div>
                        <div>47 Images</div>
                        <div>0 Tables</div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: PDF Viewer -->
            <div class="sidebar-panel" id="panel-pdf" style="display:none;">
                <div id="pdfViewerContainer" style="height: calc(100vh - 80px); display: flex; flex-direction: column;">
                    <p style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.75rem;">Source: Lec 5 Lubos_Pastor_JMP.pdf</p>
                    <iframe id="pdfFrame" src="../pdfs/Lec 5 Lubos_Pastor_JMP.pdf" style="flex:1; width:100%; border:none; border-radius: var(--radius-sm); background: var(--bg-tertiary);"></iframe>
                </div>
            </div>
            
            <!-- Tab: Notes -->
            <div class="sidebar-panel" id="panel-notes" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <span style="font-size: 0.85rem; color: var(--text-tertiary);" id="notesCount">0 notes</span>
                    <button onclick="exportNotesToObsidian()" class="action-btn" style="width:auto; padding: 0.4rem 0.75rem; font-size: 0.8rem;">Export .md</button>
                </div>
                <div id="notesList" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 32vh; overflow-y: auto;"></div>
                <div id="noteReader" class="note-reader">
                    <div class="reader-title">Reading</div>
                    <div class="reader-content">Click a note in history to read it here.</div>
                </div>
                <div style="margin-top: 0.75rem; border-top: 1px solid var(--border-color); padding-top: 0.75rem;">
                    <textarea id="noteInput" oninput="handleNoteInputChange(this.value)" placeholder="Write a note (Markdown supported)..." style="width:100%; min-height: 80px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 0.5rem; color: var(--text-primary); font-family: var(--font-mono); font-size: 0.85rem; resize: vertical;"></textarea>
                    <div id="noteDraftPreview" class="note-reader note-draft-preview">
                        <div class="reader-title">Live Preview</div>
                        <div class="reader-content" id="noteDraftPreviewContent">Type in the note box to preview Markdown rendering in real time.</div>
                    </div>
                    <button onclick="addFreeNote()" class="action-btn" style="margin-top: 0.375rem;">Add Note</button>
                </div>
            </div>
        </aside>

        <div class="column-resizer" id="resizerLeft" role="separator" aria-orientation="vertical" aria-label="Resize left sidebar"></div>

        <!-- Main Content -->
        <main class="main-content">
            <header id="overview">
                <h1>Lec 5 Lubos_Pastor_JMP</h1>
                <p style="font-size: 1.1rem; color: var(--text-tertiary); margin-bottom: 2rem;">
                    Interactive Learning Experience • Source: Lec 5 Lubos_Pastor_JMP.pdf
                </p>
                
                <!-- Course Overview -->
                <div class="feynman-block" style="border-left-color: #9f7aea;">
                    <h4>Course Overview</h4>
                    <p><strong>Difficulty:</strong> Advanced</p>
                    
                    <h5 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--accent-primary);">Prerequisites:</h5>
                    <ul style="margin-left: 1.5rem;">
                        <li>Modern Portfolio Theory (Mean-Variance Analysis)</li><li>The Capital Asset Pricing Model (CAPM)</li><li>Basic Bayesian Inference (Priors, Posteriors, and Likelihood)</li><li>Multi-factor Models of Asset Returns</li>
                    </ul>
                    
                    <h5 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--accent-secondary);">Learning Objectives:</h5>
                    <ul style="margin-left: 1.5rem;">
                        <li>Explain how Bayesian statistics can be used to integrate theoretical models into empirical financial decision making.</li><li>Contrast the 'dogmatic' use of asset pricing models with purely data-driven portfolio estimation.</li><li>Quantify how the strength of prior beliefs in a model influences optimal asset allocation weights.</li><li>Analyze the persistence of the home bias and the value effect through the lens of Bayesian prior degrees of belief.</li>
                    </ul>
                </div>
            </header>

            <!-- Concept Sections -->
            
        <section id="concept-1" class="concept-section">
            <h2>Bayesian Portfolio Selection</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Imagine trying to predict a runner's race time. Instead of just looking at their average speed, you consider various scenarios like the weather and their health, then combine all those possibilities to see a full range of potential finish times rather than a single guess.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>Traditional portfolio models often fail because they treat historical averages as absolute truths, leading to extreme and risky bets. Bayesian selection accounts for 'estimation risk,' creating more stable and realistic portfolios by acknowledging that our data is limited and our parameters might be wrong.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="diagram-container">
            <div class="diagram-title">The Bayesian Predictive Simulation Process</div>
            <div class="mermaid">
flowchart TD
    A[Step 1: Draw Benchmark Returns] -->|Uses Student-t Distribution| B[Step 2: Draw Model Parameters]
    B -->|Gibbs Sampling for B and Sigma| C[Step 3: Draw Asset Returns]
    C -->|Conditional on Steps 1 and 2| D[Final Result: Simulated Predictive Distribution]
    D --> E[Estimate Mean and Variance for Portfolio Weights]
            </div>
            <div class="diagram-caption">How returns are simulated by layering uncertainty from benchmarks and parameters.</div>
        </div>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Bayesian portfolio selection uses a predictive density rather than fixed point estimates for expected returns. It recognizes that we don't know the 'true' mean or variance of an asset; we only have a probability distribution of what those parameters might be based on past data. The process involves integrating the conditional likelihood of future returns over the posterior distribution of the model parameters. This results in a 'predictive' distribution—often a Student-t distribution—which has fatter tails than a normal distribution. By incorporating this uncertainty, the model naturally produces more conservative asset weights that are less sensitive to small changes in the input data.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>PAGE 13
============================================================

190 The Journal of Finance D. Predictive Return Density Recall that Bayesian portfolio selection is based on the predictive density of the (excess) returns on the investable assets. Let  FL,1  denote the 1 x K vector of the next-period benchmark returns. The predictive density of the benchmark returns equals P(FL+1  FL)= fp(FL+1 EF,VF,FL)P(EF,VFI FL)dEFdVF. (21) This predictive density corresponds to a multivariate Student  t </div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Suppose you are investing in a new AI fund based on 12 months of data. Instead of just using the 2% average monthly return, the Bayesian approach simulates 10,000 possible futures. It first draws potential market conditions, then draws different possible 'Alpha' values for the fund that are consistent with your data, and finally calculates a spread of returns. This might show that while 2% is the average, there is a significant 15% chance of a total loss, prompting you to invest less than a traditional model would suggest.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>A common error is assuming Bayesian selection just uses a different average return 'plug-in' for the standard formula. In reality, it changes the entire shape of the risk profile, reflecting that our lack of knowledge about the 'true' parameters adds an extra layer of risk that must be managed.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> According to the provided text, what distribution describes the predictive density of the benchmark returns (F_L+1)?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        A multivariate Normal distribution with L degrees of freedom
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        A multivariate Student t distribution with L - K degrees of freedom
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        A Poisson distribution with K degrees of freedom
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        A multivariate Cauchy distribution with L - K degrees of freedom
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text explicitly states that the predictive density of benchmark returns corresponds to a multivariate Student t distribution with L - K degrees of freedom.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text explicitly states that the predictive density of benchmark returns corresponds to a multivariate Student t distribution with L - K degrees of freedom.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> When making draws of asset returns (R_L+1) from the predictive density, which method is used to draw the regression parameters B and Σ?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Maximum Likelihood Estimation
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Bootstrap Resampling
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Gibbs sampling
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Linear Interpolation
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text specifies that the regression parameters B and Σ (noted as Y in the text) are drawn using Gibbs sampling as described in Appendix C.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text specifies that the regression parameters B and Σ (noted as Y in the text) are drawn using Gibbs sampling as described in Appendix C.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> Why is the density of asset returns p(R_L+1 | B, Σ, F_L+1) considered to be normal?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Because it is a property of the Student t distribution
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Because the error term U_L+1 is distributed as N(0, Σ)
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Because the benchmark returns are assumed to be normal
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Because Gibbs sampling always results in normal densities
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text notes the density is normal because the asset return is defined as a linear regression where the error term U_L+1 follows a normal distribution with mean zero and variance Σ.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text notes the density is normal because the asset return is defined as a linear regression where the error term U_L+1 follows a normal distribution with mean zero and variance Σ.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-2" class="concept-section">
            <h2>Asset Pricing Models</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Pricing an asset is like setting the insurance premium for a driver; the cost isn't random but is calculated based on specific risk factors like age, driving history, and car type. Just as a riskier driver pays a higher premium to compensate the insurer, a riskier investment must offer a higher potential return to attract an investor.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>Asset pricing models allow investors to determine whether a stock is 'cheap' or 'expensive' by calculating its fair value relative to its risk. They are essential for pension funds and individual savers to build portfolios that maximize returns while staying within a safe level of volatility.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="diagram-container">
            <div class="diagram-title">The Asset Pricing Process</div>
            <div class="mermaid">
flowchart TD
    A[Asset Data & Market Factors] --> B{Asset Pricing Model}
    B --> C[Calculate Systematic Risk/Beta]
    B --> D[Incorporate Model Uncertainty]
    C & D --> E[Determine Expected Return/Fair Price]
    E --> F[Compare to Market Price]
    F --> G[Identify Alpha/Mispricing]
            </div>
            <div class="diagram-caption">How models translate raw data and risk factors into a required rate of return.</div>
        </div>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Asset pricing models are frameworks used to determine the required rate of return for an investment based on its exposure to systematic risk. Instead of looking at an asset in isolation, these models—like the Capital Asset Pricing Model (CAPM) or the Fama-French factors—argue that the price is driven by how the asset moves in relation to the broader market or specific economic 'factors.' Ľuboš Pástor’s work specifically highlights the bridge between these theoretical models and practical portfolio selection, noting that because we can never be certain which model is perfectly accurate, we must incorporate 'model uncertainty' into our calculations. By quantifying risk, these models ensure that investors are appropriately compensated for the 'beta' (market sensitivity) they take on, effectively filtering out noise to find the fundamental value.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>PAGE 1
============================================================

American Finance Association Portfolio Selection and Asset Pricing Models Author(s): Ľuboš Pástor Source: The Journal of Finance, Vol. 55, No. 1 (Feb., 2000), pp. 179-223 Published by: Blackwell Publishing for the American Finance Association Stable URL:  http://www.jstor.org/stable/222554 Accessed: 24/12/2008 17:22 Your use of the JSTOR archive indicates your acceptance of JSTOR's Terms and Conditions of Use, available at http</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Suppose the risk-free rate is 2% and the market premium is 6%. If a stock has a 'Beta' of 1.5, an asset pricing model predicts it should return 11% (2% + 1.5 * 6%) to justify its risk. If the stock is currently trending toward a 13% return, the model identifies it as undervalued, suggesting it is a good buy because the extra 2% (Alpha) is not explained by its risk level.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Students often believe that all risk leads to higher returns, but models distinguish between 'systematic risk' (which pays a premium) and 'idiosyncratic risk' (which doesn't). You aren't rewarded for the risk of a single company's factory burning down because you could have easily eliminated that risk through diversification.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> According to the provided document, which author is credited with the research titled 'Portfolio Selection and Asset Pricing Models'?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Eugene Fama
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Kenneth French
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Ľuboš Pástor
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Harry Markowitz
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text explicitly lists Ľuboš Pástor as the author of the article published in The Journal of Finance.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text explicitly lists Ľuboš Pástor as the author of the article published in The Journal of Finance.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> In the context of the article's title, asset pricing models are studied in conjunction with which other financial process?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Corporate Governance
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Portfolio Selection
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Dividend Policy
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Capital Structure
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The title of the paper clearly states 'Portfolio Selection and Asset Pricing Models,' indicating a direct link between the two concepts.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The title of the paper clearly states 'Portfolio Selection and Asset Pricing Models,' indicating a direct link between the two concepts.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> In which academic journal was the referenced research on asset pricing models published in February 2000?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Review of Financial Studies
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Journal of Financial Economics
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        The Journal of Finance
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Journal of Monetary Economics
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The metadata indicates that the source of the paper is The Journal of Finance, Vol. 55, No. 1.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The metadata indicates that the source of the paper is The Journal of Finance, Vol. 55, No. 1.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-3" class="concept-section">
            <h2>Prior Beliefs</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Think of prior beliefs like a restaurant's long-standing reputation versus a single recent bad review. You don't ignore years of excellence just because of one bad night, but you also don't ignore the recent warning; instead, you weigh the reputation against the new evidence to decide if you should eat there.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>Financial data is often 'noisy' and can lead to erratic investment choices if we only look at recent trends. By using prior beliefs rooted in established finance theory, investors can stay grounded and avoid making extreme, risky bets based on temporary market flukes.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="comparison-block">
            <div class="comparison-side left">
                <h4>🔵 Traditional Hypothesis Testing</h4>
                <ul><li>Binary outcome: Accept or Reject the model</li><li>Ignores model intuition if data is noisy</li><li>Can lead to extreme portfolio shifts</li><li>Treats theory as 'true' or 'false'</li></ul>
            </div>
            <div class="comparison-divider">vs</div>
            <div class="comparison-side right">
                <h4>🟢 Bayesian Prior Beliefs</h4>
                <ul><li>Nuanced outcome: Degrees of belief</li><li>Uses theory to 'anchor' messy data</li><li>Produces stable, balanced portfolios</li><li>Treats theory as a 'useful simplification'</li></ul>
            </div>
        </div>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Prior beliefs represent an investor's initial conviction in a financial theory, such as the CAPM, before they even look at current market data. In a Bayesian framework, we don't treat models as 'all or nothing' outcomes of a hypothesis test; instead, we recognize that while no model is perfect, theory provides a valuable anchor. We combine these theoretical expectations (the prior) with fresh empirical evidence (the data) to reach a balanced conclusion called a posterior belief. This approach prevents us from being 'dogmatic' followers who ignore reality, but also saves us from discarding useful theoretical insights just because the data is momentarily messy.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>
## Pricing Models

LUBO0 PASTOR* ABSTRACT Finance theory can be used to form informative prior beliefs in financial decision making. This paper approaches portfolio selection in a Bayesian framework that incorporates a prior degree of belief in an asset pricing model. Sample evidence on home bias and value and size effects is evaluated from an asset-allocation perspec- tive. U.S. investors' belief in the domestic CAPM must be very strong to justify the home bias observed in their equity holding</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Imagine the CAPM predicts a stock will return 7%, but recent market data shows it returning 15%. A trader relying only on data might over-allocate to this stock expecting 15%, while a dogmatic theorist would stick strictly to 7%. An investor using prior beliefs might give the model 60% weight and the data 40% weight, resulting in a 'shrunk' estimate of 10.2%, which balances theoretical risk with actual performance.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Students often assume that if a statistical test 'rejects' a model, the model is useless and should be set to zero. In practice, even a 'rejected' model can be a powerful prior because it provides a logical structure that helps make sense of chaotic data.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> According to the text, how does the Bayesian framework improve upon traditional empirical finance when using asset pricing models?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        It requires that a model be statistically perfect before it can be used for decision making.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        It allows decision makers to incorporate a prior degree of belief in a model rather than just accepting or rejecting it.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It eliminates the need for data by relying solely on theoretical finance models.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It proves that the domestic CAPM is the only valid model for global asset allocation.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The Bayesian framework allows for the integration of theoretical models as informative prior beliefs, avoiding the binary 'reject or not reject' limitation of traditional hypothesis testing.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The Bayesian framework allows for the integration of theoretical models as informative prior beliefs, avoiding the binary 'reject or not reject' limitation of traditional hypothesis testing.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> Based on the author's analysis, what must be true about U.S. investors' prior beliefs to justify their high level of 'home bias'?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        They must have a very weak belief in the domestic CAPM.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        They must rely entirely on sample evidence without any prior theoretical beliefs.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        They must have a very strong prior belief in the domestic CAPM.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        They must believe that the Fama-French model is superior to the CAPM.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text states that a very strong belief in the domestic CAPM is necessary to justify why U.S. investors hold such a disproportionate amount of domestic equity.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text states that a very strong belief in the domestic CAPM is necessary to justify why U.S. investors hold such a disproportionate amount of domestic equity.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> What is the primary criticism mentioned regarding the use of simplistic hypothesis testing for financial models?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        It is too computationally expensive for modern portfolio selection.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        It fails to capture potentially useful aspects of a model that could assist a decision maker even if the model is rejected.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It relies too heavily on subjective prior beliefs rather than objective market data.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It ignores the value and size effects discovered by Fama and French.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The author argues that a simplistic 'reject/not reject' approach overlooks nuances in the model and data that remain valuable for making informed financial decisions.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The author argues that a simplistic 'reject/not reject' approach overlooks nuances in the model and data that remain valuable for making informed financial decisions.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-4" class="concept-section">
            <h2>Model-based vs. Data-based Approaches</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Think of planning a commute: a 'Model-based' approach follows the speed limit and distances on a map (theory), while a 'Data-based' approach only looks at how fast you drove yesterday (statistics). The map is a reliable guide but ignores traffic, whereas yesterday’s speed might have been a lucky fluke that won't happen again.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>This tension dictates how billions of dollars are invested; relying too much on theory ignores real opportunities, but relying too much on historical data leads to 'overfitting,' where you bet everything on past luck that likely won't repeat. Balancing these allows investors to use economic logic to filter out the 'noise' found in volatile market data.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="comparison-block">
            <div class="comparison-side left">
                <h4>🔵 Model-Based (Theory)</h4>
                <ul><li>Assumes markets are efficient (e.g., CAPM)</li><li>Low 'Estimation Risk' (fewer variables to guess)</li><li>Focuses on long-term economic logic</li><li>Result: Hold the Market Portfolio</li></ul>
            </div>
            <div class="comparison-divider">vs</div>
            <div class="comparison-side right">
                <h4>🟢 Data-Based (Sample Statistics)</h4>
                <ul><li>Relies on historical mean and variance</li><li>High 'Estimation Risk' (sensitive to outliers)</li><li>Focuses on what actually happened recently</li><li>Result: Mean-Variance Optimized Portfolio</li></ul>
            </div>
        </div>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>The Model-based approach relies on asset pricing theories like the CAPM, which argue that since markets are efficient, the only logical portfolio is the market itself. In contrast, the Data-based approach uses Mean-Variance Optimization to find the 'mathematically best' portfolio based on historical averages and correlations. The conflict arises because theoretical models are often too rigid (mispricing exists), while historical data is 'noisy' (past returns are poor predictors of the future). Lubos Pástor’s research bridges this gap using Bayesian analysis, allowing an investor to treat the theoretical model as a 'prior' belief and only move away from it when the data provides overwhelming evidence of a better opportunity.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>The tension between selecting portfolios based purely on theory (e.g., holding the market) versus using only sample statistics (mean-variance optimization).</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>If the CAPM (Model) says a specific stock should return 7%, but the last three years of data show it returned 20%, a pure Data-based investor would load up on that stock. A Model-based investor would ignore the 20% and stick to the market average. A balanced approach would calculate that the 20% return is likely 80% noise and 20% true performance, resulting in a slight increase in the stock holding rather than a massive, risky bet.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Students often assume that having more historical data makes the Data-based approach superior, failing to realize that financial data is so volatile that 'more' data often just introduces more historical noise rather than more predictive power.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> Which of the following best describes a purely 'model-based' approach to portfolio selection?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Using historical sample means to find the tangency portfolio
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Holding the market portfolio based on the Capital Asset Pricing Model (CAPM) equilibrium
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Calculating the covariance matrix from the last ten years of stock returns
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Using a computer algorithm to identify technical patterns in price data
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! A model-based approach relies on financial theory, such as the CAPM, which suggests that in equilibrium, the most efficient portfolio for every investor is the market portfolio.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. A model-based approach relies on financial theory, such as the CAPM, which suggests that in equilibrium, the most efficient portfolio for every investor is the market portfolio.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> What is the primary risk associated with a strictly 'data-based' approach, such as Mean-Variance Optimization (MVO) using sample statistics?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        The approach is too simple to account for diversification
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It ignores all historical price movements and trends
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Small estimation errors in sample means can lead to extreme and unstable portfolio weights
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It assumes that markets are always in theoretical equilibrium
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Purely data-driven MVO is notoriously sensitive to input noise, often resulting in 'error maximization' where the optimizer over-allocates to assets with high sampled returns that may not persist.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Purely data-driven MVO is notoriously sensitive to input noise, often resulting in 'error maximization' where the optimizer over-allocates to assets with high sampled returns that may not persist.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> The tension between theory and data in portfolio construction is often resolved by which of the following?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="true">
                        Choosing between the structural robustness of a model and the empirical specificity of data
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Ignoring mathematical optimization entirely in favor of random selection
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Assuming that sample statistics are always identical to theoretical parameters
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Using only qualitative judgment to avoid using any data or models
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Investors must balance the stability and logic of theoretical models (like holding the market) against the desire to use realized data to find potentially superior risk-adjusted returns.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Investors must balance the stability and logic of theoretical models (like holding the market) against the desire to use realized data to find potentially superior risk-adjusted returns.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-5" class="concept-section">
            <h2>Home Bias</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Imagine a diner who only eats at the local neighborhood cafe because they trust the cook, even though a food critic provides data showing that a global buffet across town offers better nutrition at a lower price. The diner's overwhelming trust in the familiar local menu prevents them from benefiting from the variety and safety of a balanced diet.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>Home bias explains why most portfolios are not as efficient as they could be, leading to unnecessary risk and missed growth opportunities in international markets. It highlights the gap between mathematical financial theory, which suggests global diversification, and human behavior, which favors the familiar.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="comparison-block">
            <div class="comparison-side left">
                <h4>🔵 Theoretical Global Portfolio</h4>
                <ul><li>Diversified across all global markets</li><li>Weighted by total world market cap</li><li>Lower unsystematic risk</li><li>Follows standard CAPM evidence</li></ul>
            </div>
            <div class="comparison-divider">vs</div>
            <div class="comparison-side right">
                <h4>🟢 Home Bias Portfolio</h4>
                <ul><li>Over-concentrated in domestic stocks</li><li>Weighted by geographic proximity</li><li>High exposure to local economic shocks</li><li>Driven by extreme 'prior beliefs' in local models</li></ul>
            </div>
        </div>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Home bias is the tendency of investors to over-allocate their portfolio to domestic equities while ignoring the benefits of international diversification. Luboš Pástor explains this through a Bayesian lens: for an investor's heavy domestic concentration to be considered 'optimal,' they must hold an incredibly strong 'prior belief' that their domestic pricing model (like the CAPM) is the absolute truth. In this framework, the investor's mental conviction is so powerful that it effectively ignores 'sample evidence'—the actual market data showing that foreign stocks could reduce risk and improve returns. Essentially, the subjective belief in the home market's superiority overrides the objective data suggesting a global approach.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>
## Pricing Models

LUBO0 PASTOR* ABSTRACT Finance theory can be used to form informative prior beliefs in financial decision making. This paper approaches portfolio selection in a Bayesian framework that incorporates a prior degree of belief in an asset pricing model. Sample evidence on home bias and value and size effects is evaluated from an asset-allocation perspec- tive. U.S. investors' belief in the domestic CAPM must be very strong to justify the home bias observed in their equity holding</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>If the U.S. stock market represents 40% of the total global market value, a perfectly diversified investor should hold 60% of their assets in international stocks. However, a typical U.S. investor might hold 90% of their wealth in domestic stocks. To justify this 90% allocation, Pástor argues the investor must believe with near-certainty that the U.S. market is perfectly efficient and that international markets offer no additional risk-adjusted benefit.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Students often mistake home bias for simple patriotism, but it is actually a specific failure of risk management where an investor's portfolio is unnecessarily sensitive to a single country's economic shocks.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> According to the text, what is required to justify the level of home bias observed in the equity holdings of U.S. investors?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        A lack of data regarding international market performance
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        A very strong belief in the domestic Capital Asset Pricing Model (CAPM)
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The complete rejection of the Fama-French book-to-market portfolio
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        A preference for size effects over value effects
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text states that U.S. investors' belief in the domestic CAPM must be very strong to justify the home bias observed in their portfolios.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text states that U.S. investors' belief in the domestic CAPM must be very strong to justify the home bias observed in their portfolios.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> How does the paper suggest financial decision makers should use asset pricing models?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        As the absolute truth if a hypothesis test fails to reject them
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        By discarding them as worthless if they are rejected by sample data
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        To form informative prior beliefs within a Bayesian framework
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        By ignoring them in favor of purely empirical sample evidence
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The author proposes using a Bayesian framework where finance theory informs a decision maker's prior beliefs rather than relying on a binary 'reject or not reject' test.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The author proposes using a Bayesian framework where finance theory informs a decision maker's prior beliefs rather than relying on a binary 'reject or not reject' test.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> What is the author's primary critique of the standard empirical approach to theoretical models?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        It is too mathematically complex for the average investor to utilize
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It focuses too much on international diversification and ignores domestic trends
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        It fails to capture many useful aspects of both the model and the data for decision making
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It relies too heavily on the Fama-French model instead of the standard CAPM
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text argues that a simplistic approach based solely on hypothesis tests misses valuable insights from both the model and the data that could assist decision makers.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text argues that a simplistic approach based solely on hypothesis tests misses valuable insights from both the model and the data that could assist decision makers.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-6" class="concept-section">
            <h2>Mean-Variance Framework</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Choosing a commute is like the mean-variance framework: you want the route with the fastest average time (the mean) but also the one with the fewest unpredictable traffic jams (the variance). You balance the desire for speed against the need for a predictable arrival time.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>This framework is the bedrock of modern finance, allowing investors to scientifically quantify the trade-off between potential profit and the risk of losing money. It enables the creation of 'efficient' portfolios that maximize returns for a specific level of risk, moving beyond mere guesswork.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="chart-container">
            <div class="chart-title">The Efficient Frontier: Mean vs. Variance</div>
            <canvas id="chart-6" style="max-height:380px;"></canvas>
            <div class="chart-caption">The curve represents the optimal portfolios (Efficient Frontier) where you get the maximum return (Mean) for every level of risk (Standard Deviation/Variance).</div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('chart-6');
            if (ctx && typeof Chart !== 'undefined') {
                new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        labels: ["Risk", "Return"],
                        datasets: [{"label": "Efficient Frontier", "data": [{"x": 5, "y": 4}, {"x": 7, "y": 7}, {"x": 10, "y": 10}, {"x": 15, "y": 12}, {"x": 25, "y": 14}], "borderColor": "#4299e1", "backgroundColor": "rgba(66,153,225,0.15)"}]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { color: 'rgba(255,255,255,0.05)' } }
            }
                    }
                });
            }
        });
        </script>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>The Mean-Variance Framework evaluates investments based on two primary statistical measures: the 'mean,' which represents the expected average return, and 'variance,' which measures the spread or volatility of those returns. Instead of looking at assets in isolation, it considers how assets move in relation to one another, known as covariance. By mathematically combining assets that are not perfectly correlated, an investor can reduce the overall portfolio variance (risk) without necessarily lowering the mean (reward). The ultimate goal is to find an allocation of wealth that sits on the 'efficient frontier,' where no additional return can be gained without taking on more risk.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>PAGE 3
============================================================

180 The Journal of Finance A natural approach to using financial models in decision making can be developed in a Bayesian framework. A model can be used as a point of ref- erence around which the decision maker can center his prior beliefs. These prior beliefs are combined with the data, which may violate the implications of the model, and the revised beliefs are used to make decisions. The relative importance of the sample evi</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Imagine you have two stocks: Stock A expects a 12% return but is highly volatile, while Stock B expects 4% and is very stable. If you put all your money in A, your 'mean' is high but your 'variance' is dangerous; if you choose B, your risk is low but so is your reward. Using the mean-variance framework, you might find that a 70/30 split provides an 9.6% return with significantly less volatility than Stock A alone because the two assets don't always move in the same direction.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>A common error is focusing only on the high 'mean' return of an asset while ignoring its 'variance' and how it correlates with the rest of the portfolio. This leads to 'diversification in name only,' where an investor holds many different assets that all crash at the exact same time during a market downturn.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> In the context of the 'data-based' approach to the mean-variance framework, what specific data are used to compute optimal portfolio weights?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        The historical price-to-earnings ratios of the assets
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Qualitative assessments of market sentiment and volatility
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Sample estimates of the mean and covariance matrix of asset returns
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The strict mathematical implications of asset pricing models
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text specifies that sample estimates of the mean and covariance matrix are used to determine optimal weights in a data-based mean-variance framework.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text specifies that sample estimates of the mean and covariance matrix are used to determine optimal weights in a data-based mean-variance framework.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> According to the text, what is a primary drawback of relying solely on a 'data-based' approach for portfolio selection?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="true">
                        It ignores the potential usefulness of asset pricing models.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It requires too much computational power to calculate covariance.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It cannot be used with a time series of returns.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It assumes that returns do not follow a functional distribution.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The passage explicitly states that the data-based approach is limited because it ignores the potential benefits that asset pricing models can offer.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The passage explicitly states that the data-based approach is limited because it ignores the potential benefits that asset pricing models can offer.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> How does the Bayesian framework described in the text utilize a financial model in the decision-making process?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        It uses the model as the final decision without considering data.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        It uses the model as a point of reference around which the decision maker centers prior beliefs.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It uses the model to replace the need for mean-variance calculations.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It uses the model only when the sample evidence perfectly matches it.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text explains that the model serves as a reference point for prior beliefs, which are then revised based on the sample evidence.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text explains that the model serves as a reference point for prior beliefs, which are then revised based on the sample evidence.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-7" class="concept-section">
            <h2>Priced Sources of Risk</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Think of a professional fisherman: they get paid more for going out in a stormy sea that affects everyone (a priced risk), but they don't get paid extra for having a hole in their own specific boat (an unpriced risk). Because the fisherman could have fixed the hole, the market doesn't reward them for that unnecessary danger, only for the unavoidable danger of the ocean.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>This concept helps investors stop gambling on individual company drama and start focusing on the broad economic forces that actually generate profit. By identifying priced risks, you can build a portfolio that maximizes your compensation while ignoring 'junk' risks that offer no extra return.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="comparison-block">
            <div class="comparison-side left">
                <h4>🔵 Priced Risk (Systematic)</h4>
                <ul><li>Affects the entire market or economy</li><li>Cannot be removed through diversification</li><li>Investors are compensated with a 'Risk Premium'</li><li>Basis for 'Model-Based' portfolio selection</li></ul>
            </div>
            <div class="comparison-divider">vs</div>
            <div class="comparison-side right">
                <h4>🟢 Unpriced Risk (Idiosyncratic)</h4>
                <ul><li>Specific to one company or industry</li><li>Can be eliminated by holding many assets</li><li>No extra expected return for holding it</li><li>Ignored by efficient asset pricing models</li></ul>
            </div>
        </div>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>In finance, a risk is 'priced' if the market offers a higher expected return as a reward for moving that risk from someone else's shoulders to your own. There are two types of risk: specific risks that affect only one company and systemic risks that affect the whole economy. Because you can easily get rid of company-specific risk by simply owning a mix of different stocks (diversification), the market won't pay you a premium for holding it. However, you cannot escape economy-wide risks—like a sudden rise in interest rates or a recession—so the market must 'price' this risk by offering higher potential returns to entice people to take it. A model-based investment strategy focuses exclusively on these systemic benchmarks because they are the only reliable source of extra pay for the danger you are taking.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>PAGE 3
============================================================

180 The Journal of Finance A natural approach to using financial models in decision making can be developed in a Bayesian framework. A model can be used as a point of ref- erence around which the decision maker can center his prior beliefs. These prior beliefs are combined with the data, which may violate the implications of the model, and the revised beliefs are used to make decisions. The relative importance of the sample evi</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>In the Capital Asset Pricing Model (CAPM), the only priced source of risk is the movement of the entire stock market. If you buy a single stock like Tesla, you are taking on 'Market Risk' plus 'Tesla-specific Risk.' While the Market Risk is priced and earns you a premium, the Tesla-specific risk is unpriced; if Tesla's factory has a unique power outage, you lose money without having been 'paid' an extra expected return for that specific possibility, since you could have avoided it by owning an index fund.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Students often wrongly assume that any high-risk investment must offer a high reward. They fail to realize that the market only compensates you for 'undiversifiable' risk, meaning you can take a massive amount of specific risk and expect zero extra compensation for it.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> According to the text, what characterizes the 'data-based' approach to portfolio selection?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        It centers prior beliefs around an asset pricing model.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        It uses sample estimates of the mean and covariance matrix to compute optimal weights.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It defines optimal portfolios as combinations of benchmark assets.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It prioritizes theoretical implications over time-series data.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text states that the data-based approach estimates parameters from the time series of returns, such as sample estimates of the mean and covariance, to find optimal weights.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text states that the data-based approach estimates parameters from the time series of returns, such as sample estimates of the mean and covariance, to find optimal weights.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> In the described Bayesian framework, what determines the relative importance of sample evidence versus the model?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        The length of the time series of returns being analyzed.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The specific functional form chosen for the distribution of returns.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        The strength of model violations in the data relative to the strength of the prior belief in the model.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The number of benchmark portfolios available in the asset pricing model.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text explains that the weight given to data versus the model depends on how much the data violates the model compared to the strength of the decision maker's prior belief.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text explains that the weight given to data versus the model depends on how much the data violates the model compared to the strength of the decision maker's prior belief.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> What does the 'model-based' approach to portfolio selection imply regarding an investor's optimal portfolio?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="true">
                        It is a combination of benchmark portfolios.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It ignores the implications of asset pricing models.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It is based strictly on a functional form of return distributions.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It is derived solely from sample evidence of asset returns.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text notes that in the model-based approach, every investor's optimal portfolio is seen as a combination of benchmark portfolios.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text notes that in the model-based approach, every investor's optimal portfolio is seen as a combination of benchmark portfolios.
                    </div>
                </div>
                
        </section>
        
            
            <!-- Completion -->
            <div style="margin-top: 4rem; padding: 2rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 12px; text-align: center; color: white;">
                <h3 style="margin-bottom: 1rem;">Course Complete!</h3>
                <p>You've reviewed all 7 main concepts. Keep practicing with the quizzes above.</p>
            </div>
        </main>

        <div class="column-resizer" id="resizerRight" role="separator" aria-orientation="vertical" aria-label="Resize right sidebar"></div>

        <!-- Right Sidebar: AI Assistant & Tools -->
        <aside class="sidebar-right">
            <div class="ai-chat">
                <div class="ai-chat-header">
                    <div>
                        <h3 style="margin: 0;">AI Study Assistant</h3>
                        <p style="font-size: 0.8rem; color: var(--text-tertiary); margin: 0;">Powered by Gemini</p>
                    </div>
                </div>
                
                <div class="ai-chat-messages" id="aiMessages">
                    <div class="ai-message assistant">
                        Hi! I'm your AI study assistant. Ask me anything about this topic, or request:
                        <ul style="margin-top: 0.5rem; padding-left: 1.5rem; font-size: 0.9rem;">
                            <li>Explanations in simpler terms</li>
                            <li>More examples</li>
                            <li>Practice questions</li>
                            <li>Connections to other concepts</li>
                        </ul>
                    </div>
                </div>
                
                <div class="ai-input-group">
                    <input 
                        type="text" 
                        class="ai-input" 
                        id="aiInput" 
                        placeholder="Ask a question..."
                        onkeypress="if(event.key==='Enter') sendAIMessage()"
                    />
                    <button class="ai-send-btn" onclick="sendAIMessage()">Send</button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="margin-top: 2rem;">
                <h4 style="margin-bottom: 1rem; color: var(--text-tertiary);">Quick Actions</h4>
                <button onclick="reviewAllQuizzes()" class="action-btn">
                    Review All Quizzes
                </button>
                <button onclick="createSummary()" class="action-btn">
                    Generate Summary
                </button>
                <button onclick="window.print()" class="action-btn">
                    Print Notes
                </button>
            </div>
            
            <!-- Keyboard Shortcuts -->
            <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.85rem;">
                <h5 style="margin-bottom: 0.75rem; color: var(--text-tertiary);">Shortcuts</h5>
                <div id="shortcutsDisplay" style="color: var(--text-secondary); line-height: 1.8;">
                    <div><kbd id="shortcutFocusAI">Alt+A</kbd> Focus AI</div>
                    <div><kbd id="shortcutSummary">Alt+S</kbd> Summary</div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        
        // ── Gemini Proxy Configuration ──
        const GEMINI_PROXY_URL = '../api/gemini';
        const LAYOUT_STORAGE_KEY = 'learning-layout-widths-v1';
        
        let courseContext = '';
        let conversationHistory = [];

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        // ── Main Controller ──
        class LearningPageController {
            constructor() {
                this.isMac = /Mac|iPhone|iPod|iPad/i.test(navigator.platform);
                this.setupExpandables();
                this.setupQuizzes();
                this.setupProgressTracking();
                this.setupScrollReveal();
                this.setupCourseContext();
                this.setupKeyboardShortcuts();
                this.initializeMermaid();
                this.initializeCharts();
                this.updateShortcutsDisplay();
                this.setupColumnResizers();
            }
            
            initializeMermaid() {
                if (typeof mermaid !== 'undefined') {
                    mermaid.initialize({
                        startOnLoad: true,
                        theme: 'dark',
                        themeVariables: {
                            primaryColor: '#263352',
                            primaryTextColor: '#edf2f7',
                            primaryBorderColor: '#f6c177',
                            lineColor: '#a0aec0',
                            secondaryColor: '#1f2b47',
                            tertiaryColor: '#1c2a45',
                            background: '#16213e',
                            mainBkg: '#263352',
                            nodeBorder: '#f6c177',
                            clusterBkg: '#1f2b47',
                            fontSize: '14px'
                        },
                        flowchart: { curve: 'basis', padding: 20 },
                        sequence: { actorMargin: 50 }
                    });
                }
            }
            
            initializeCharts() {
                if (typeof Chart !== 'undefined') {
                    Chart.defaults.color = '#a0aec0';
                    Chart.defaults.borderColor = 'rgba(255,255,255,0.06)';
                    Chart.defaults.font.family = "-apple-system, 'Helvetica Neue', sans-serif";
                    Chart.defaults.responsive = true;
                    Chart.defaults.maintainAspectRatio = true;
                    Chart.defaults.plugins.legend.labels.usePointStyle = true;
                }
            }
            
            setupCourseContext() {
                const mc = document.querySelector('.main-content');
                if (mc) courseContext = mc.innerText.substring(0, 6000);
            }
            
            setupExpandables() {
                document.querySelectorAll('.expandable-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.parentElement.classList.toggle('open');
                    });
                });
            }
            
            setupQuizzes() {
                document.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.addEventListener('click', () => this.handleQuiz(opt));
                });
            }

            handleQuiz(option) {
                const quiz = option.closest('.quiz-container');
                const isCorrect = option.dataset.correct === 'true';
                
                quiz.querySelectorAll('.quiz-option').forEach(o => {
                    o.classList.remove('selected','correct','incorrect');
                });
                
                option.classList.add('selected');
                option.classList.add(isCorrect ? 'correct' : 'incorrect');
                
                if (!isCorrect) {
                    quiz.querySelectorAll('.quiz-option').forEach(o => {
                        if (o.dataset.correct === 'true') o.classList.add('correct');
                    });
                }
                
                const cf = quiz.querySelector('.quiz-feedback.correct');
                const ic = quiz.querySelector('.quiz-feedback.incorrect');
                if (isCorrect) { cf.classList.add('show'); ic.classList.remove('show'); }
                else { ic.classList.add('show'); cf.classList.remove('show'); }
            }

            
            setupProgressTracking() {
                window.addEventListener('scroll', () => {
                    const h = document.documentElement.scrollHeight - window.innerHeight;
                    const p = h > 0 ? Math.min((window.scrollY / h) * 100, 100) : 0;
                    document.getElementById('progressBar').style.width = p + '%';
                });
            }
            
            setupScrollReveal() {
                const obs = new IntersectionObserver((entries) => {
                    entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('revealed'); });
                }, { threshold: 0.08 });
                document.querySelectorAll('.reveal-on-scroll').forEach(el => obs.observe(el));
            }
            
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.altKey && e.key === 'a') {
                        e.preventDefault();
                        document.getElementById('aiInput')?.focus();
                    }
                    if (e.altKey && e.key === 's') {
                        e.preventDefault();
                        askSummary();
                    }
                });
            }
            
            updateShortcutsDisplay() {
                const prefix = this.isMac ? '⌥' : 'Alt+';
                const focusEl = document.getElementById('shortcutFocusAI');
                const summaryEl = document.getElementById('shortcutSummary');
                if (focusEl) focusEl.textContent = prefix + 'A';
                if (summaryEl) summaryEl.textContent = prefix + 'S';
            }

            setupColumnResizers() {
                if (window.matchMedia('(max-width: 1200px)').matches) return;
                const container = document.querySelector('.page-container');
                const leftResizer = document.getElementById('resizerLeft');
                const rightResizer = document.getElementById('resizerRight');
                if (!container || !leftResizer || !rightResizer) return;

                const minLeft = 200, maxLeft = 560;
                const minRight = 220, maxRight = 560;
                const minMain = 520;
                let leftWidth = 260;
                let rightWidth = 300;

                const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
                const applyWidths = () => {
                    container.style.setProperty('--left-width', leftWidth + 'px');
                    container.style.setProperty('--right-width', rightWidth + 'px');
                };
                const getTotalWidth = () => container.getBoundingClientRect().width - 16;
                const clampAll = () => {
                    const total = getTotalWidth();
                    leftWidth = clamp(leftWidth, minLeft, maxLeft);
                    rightWidth = clamp(rightWidth, minRight, maxRight);
                    if (total - leftWidth - rightWidth < minMain) {
                        const overflow = minMain - (total - leftWidth - rightWidth);
                        leftWidth = clamp(leftWidth - overflow / 2, minLeft, maxLeft);
                        rightWidth = clamp(rightWidth - overflow / 2, minRight, maxRight);
                        if (total - leftWidth - rightWidth < minMain) {
                            const rightCap = clamp(total - leftWidth - minMain, minRight, maxRight);
                            rightWidth = rightCap;
                            leftWidth = clamp(total - rightWidth - minMain, minLeft, maxLeft);
                        }
                    }
                };

                try {
                    const cached = JSON.parse(localStorage.getItem(LAYOUT_STORAGE_KEY) || '{}');
                    if (Number.isFinite(cached.left)) leftWidth = cached.left;
                    if (Number.isFinite(cached.right)) rightWidth = cached.right;
                } catch {}
                clampAll();
                applyWidths();

                const startDrag = (side) => (evt) => {
                    evt.preventDefault();
                    const rect = container.getBoundingClientRect();
                    const total = getTotalWidth();
                    const onMove = (moveEvt) => {
                        if (side === 'left') {
                            const rawLeft = moveEvt.clientX - rect.left;
                            const maxAllowed = Math.min(maxLeft, total - rightWidth - minMain);
                            leftWidth = clamp(rawLeft, minLeft, Math.max(minLeft, maxAllowed));
                        } else {
                            const rawRight = rect.right - moveEvt.clientX;
                            const maxAllowed = Math.min(maxRight, total - leftWidth - minMain);
                            rightWidth = clamp(rawRight, minRight, Math.max(minRight, maxAllowed));
                        }
                        applyWidths();
                    };
                    const stopMove = () => {
                        document.body.style.userSelect = '';
                        document.body.style.cursor = '';
                        leftResizer.classList.remove('dragging');
                        rightResizer.classList.remove('dragging');
                        localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify({ left: leftWidth, right: rightWidth }));
                        document.removeEventListener('pointermove', onMove);
                        document.removeEventListener('pointerup', stopMove);
                    };
                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'col-resize';
                    (side === 'left' ? leftResizer : rightResizer).classList.add('dragging');
                    document.addEventListener('pointermove', onMove);
                    document.addEventListener('pointerup', stopMove);
                };

                leftResizer.addEventListener('pointerdown', startDrag('left'));
                rightResizer.addEventListener('pointerdown', startDrag('right'));
                window.addEventListener('resize', () => {
                    if (window.matchMedia('(max-width: 1200px)').matches) return;
                    clampAll();
                    applyWidths();
                });
            }
        }
        
        // ── AI Chat (Real Gemini API) ──
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            appendMsg('user', msg);
            input.value = '';
            input.disabled = true;
            
            const typingEl = appendMsg('assistant', '<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>');
            
            try {
                const answer = await callGemini(msg);
                typingEl.innerHTML = formatMd(answer);
            } catch (err) {
                const errMsg = err?.message || String(err);
                let hint = 'Check console for details.';
                if (window.location.protocol === 'file:' || errMsg.includes('Failed to fetch')) {
                    const current = window.location.pathname.split('/').pop();
                    hint = `Start local server: python3 serve.py --open html/${current} and ensure GEMINI_API_KEY exists in .env.local`;
                }
                typingEl.innerHTML = '⚠️ Error: ' + escapeHtml(errMsg) + '<br><small>' + escapeHtml(hint) + '</small>';
                console.error('Gemini API error:', err);
            } finally {
                input.disabled = false;
                input.focus();
            }
        }
        
        async function callGemini(userMessage) {
            if (window.location.protocol === 'file:') {
                throw new Error('This page is opened as file:// and cannot reach ../api/gemini');
            }

            const prompt = `You are a concise study assistant for this course.

Course content (excerpt):
${courseContext.substring(0, 3500)}

Previous conversation:
${conversationHistory.slice(-4).map(m => m.role + ': ' + m.content).join('\n')}

Student question: ${userMessage}

Instructions:
- Answer in 3-6 sentences, be direct and complete
- Always finish your sentences, never leave a thought incomplete
- Use the course content as reference
- If the question is in Chinese, answer in Chinese`;

            const res = await fetch(GEMINI_PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: prompt,
                    generationConfig: { temperature: 0.7, maxOutputTokens: 1024 }
                })
            });
            
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`API ${res.status}: ${errText.substring(0, 200)}`);
            }
            
            const data = await res.json();
            const candidate = data.candidates?.[0];
            const answer = candidate?.content?.parts?.[0]?.text;
            if (!answer) throw new Error('Empty response from API');
            
            // Check if response was truncated
            if (candidate?.finishReason === 'MAX_TOKENS') {
                conversationHistory.push({ role: 'user', content: userMessage }, { role: 'assistant', content: answer });
                return answer + '...\n\n_(Response was trimmed. Ask a follow-up for more detail.)_';
            }
            
            conversationHistory.push({ role: 'user', content: userMessage }, { role: 'assistant', content: answer });
            return answer;
        }
        
        function appendMsg(role, html) {
            const container = document.getElementById('aiMessages');
            const div = document.createElement('div');
            div.className = 'ai-message ' + role;
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }
        
        function formatMd(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code style="background:var(--bg-tertiary);padding:0.1em 0.4em;border-radius:3px;font-size:0.9em;">$1</code>')
                .replace(/\n/g, '<br>');
        }
        
        function askSummary() {
            const input = document.getElementById('aiInput');
            input.value = 'Please summarize the key concepts of this lesson in bullet points.';
            sendAIMessage();
        }
        
        function reviewAllQuizzes() {
            const q = document.querySelector('.quiz-container');
            if (q) q.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function createSummary() { askSummary(); }
        
        // ── Sidebar Tabs ──
        function switchSidebarTab(tabName) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-panel').forEach(p => p.style.display = 'none');
            document.querySelector(`.sidebar-tab[data-tab="${tabName}"]`)?.classList.add('active');
            const panel = document.getElementById('panel-' + tabName);
            if (panel) panel.style.display = 'block';
        }
        
        // ── Notes System ──
        const NOTES_STORAGE_KEY = 'learning-notes-' + document.title;
        const NOTES_FOCUS_KEY = NOTES_STORAGE_KEY + '-focus';
        const NOTES_ACTIVE_KEY = NOTES_STORAGE_KEY + '-active';
        const NOTES_DRAFT_KEY = NOTES_STORAGE_KEY + '-draft';
        
        function loadNotes() {
            try {
                const raw = JSON.parse(localStorage.getItem(NOTES_STORAGE_KEY) || '[]');
                if (!Array.isArray(raw)) return [];
                return raw.map((n, idx) => {
                    const idNum = Number(n?.id);
                    return {
                        id: Number.isFinite(idNum) ? idNum : -(idx + 1),
                        citation: typeof n?.citation === 'string' ? n.citation : (typeof n?.quote === 'string' ? n.quote : ''),
                        body: typeof n?.body === 'string' ? n.body : (typeof n?.text === 'string' ? n.text : (typeof n?.content === 'string' ? n.content : '')),
                        section: typeof n?.section === 'string' ? n.section : (typeof n?.title === 'string' ? n.title : ''),
                        timestamp: typeof n?.timestamp === 'string' && n.timestamp
                            ? n.timestamp
                            : (typeof n?.created_at === 'string' && n.created_at ? n.created_at : new Date().toISOString())
                    };
                });
            }
            catch { return []; }
        }
        
        function saveNotes(notes) {
            localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
            renderNotes();
        }

        function saveDraft(text) {
            localStorage.setItem(NOTES_DRAFT_KEY, text || '');
        }

        function loadDraft() {
            return localStorage.getItem(NOTES_DRAFT_KEY) || '';
        }

        function renderDraftPreview(text) {
            const preview = document.getElementById('noteDraftPreviewContent');
            if (!preview) return;
            const clean = text || '';
            if (!clean.trim()) {
                preview.innerHTML = '<span style="color: var(--text-tertiary);">Type in the note box to preview Markdown rendering in real time.</span>';
                return;
            }
            preview.innerHTML = renderNoteMarkdown(clean);
        }

        function handleNoteInputChange(value) {
            saveDraft(value);
            renderDraftPreview(value);
        }

        function initNoteComposer() {
            const input = document.getElementById('noteInput');
            if (!input) return;
            const draft = loadDraft();
            input.value = draft;
            renderDraftPreview(draft);
            input.addEventListener('input', () => {
                handleNoteInputChange(input.value);
            });
            input.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    addFreeNote();
                }
            });
        }

        function getFocusedNoteId() {
            const value = localStorage.getItem(NOTES_FOCUS_KEY);
            return value ? Number(value) : null;
        }

        function getActiveNoteId() {
            const value = localStorage.getItem(NOTES_ACTIVE_KEY);
            return value ? Number(value) : null;
        }

        function setFocusedNoteId(id) {
            if (!id) localStorage.removeItem(NOTES_FOCUS_KEY);
            else localStorage.setItem(NOTES_FOCUS_KEY, String(id));
        }

        function setActiveNoteId(id) {
            if (!id) localStorage.removeItem(NOTES_ACTIVE_KEY);
            else localStorage.setItem(NOTES_ACTIVE_KEY, String(id));
        }

        function toggleFocusNote(id, e) {
            e?.stopPropagation();
            const focusedId = getFocusedNoteId();
            setFocusedNoteId(focusedId === id ? null : id);
            renderNotes();
        }

        function openNote(id) {
            setActiveNoteId(id);
            renderNotes();
            switchSidebarTab('notes');
        }

        function ensureNoteReader() {
            const panel = document.getElementById('panel-notes');
            const notesList = document.getElementById('notesList');
            if (!panel || !notesList) return null;
            notesList.style.maxHeight = '32vh';

            let reader = document.getElementById('noteReader');
            if (!reader) {
                reader = document.createElement('div');
                reader.id = 'noteReader';
                reader.className = 'note-reader';
                notesList.insertAdjacentElement('afterend', reader);
            }
            return reader;
        }

        function renderNoteMarkdown(text) {
            return escapeHtml(text || '')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function renderNoteReader(notes) {
            const reader = ensureNoteReader();
            if (!reader) return;
            if (notes.length === 0) {
                reader.innerHTML = '<div class="reader-title">Reader</div><div class="reader-content">No notes yet.</div>';
                return;
            }

            let activeId = getActiveNoteId();
            let active = notes.find(n => n.id === activeId);
            if (!active) {
                active = notes[0];
                setActiveNoteId(active.id);
            }
            const time = new Date(active.timestamp).toLocaleString();
            const citationHtml = active.citation ? `<div class="note-citation">${escapeHtml(active.citation)}</div>` : '';
            const activeBody = typeof active.body === 'string' ? active.body : '';
            reader.innerHTML = `
                <div class="reader-title">Reading • ${escapeHtml(active.section || 'General')} • ${time}</div>
                ${citationHtml}
                <div class="reader-content">${renderNoteMarkdown(activeBody)}</div>
            `;
        }
        
        function addNote(citation, body, section) {
            const notes = loadNotes();
            const note = {
                id: Date.now(),
                citation: citation || '',
                body: body || '',
                section: section || '',
                timestamp: new Date().toISOString()
            };
            notes.push(note);
            setActiveNoteId(note.id);
            saveNotes(notes);
            // Switch to notes tab
            switchSidebarTab('notes');
        }
        
        function addFreeNote() {
            const input = document.getElementById('noteInput');
            const text = input.value.trim();
            if (!text) return;
            addNote('', text, '');
            input.value = '';
            saveDraft('');
            renderDraftPreview('');
        }
        
        function deleteNote(id, e) {
            e?.stopPropagation();
            const notes = loadNotes().filter(n => n.id !== id);
            if (getFocusedNoteId() === id) setFocusedNoteId(null);
            if (getActiveNoteId() === id) setActiveNoteId(notes.length ? notes[0].id : null);
            saveNotes(notes);
        }
        
        function renderNotes() {
            const notes = loadNotes();
            const container = document.getElementById('notesList');
            const counter = document.getElementById('notesCount');
            if (!container) return;
            
            counter.textContent = notes.length + ' note' + (notes.length !== 1 ? 's' : '');
            
            if (notes.length === 0) {
                container.innerHTML = '<p style="font-size:0.85rem; color:var(--text-tertiary); text-align:center; padding:2rem 0;">Select text and click "Add Note" to begin, or write freely below.</p>';
                renderNoteReader(notes);
                return;
            }

            const focusedId = getFocusedNoteId();
            const activeId = getActiveNoteId();
            const sortedNotes = [...notes].sort((a, b) => {
                const aFocused = a.id === focusedId ? 1 : 0;
                const bFocused = b.id === focusedId ? 1 : 0;
                if (aFocused !== bFocused) return bFocused - aFocused;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            container.innerHTML = sortedNotes.map(n => {
                const time = new Date(n.timestamp).toLocaleString();
                const citationHtml = n.citation 
                    ? `<div class="note-citation">${escapeHtml(n.citation)}</div>` 
                    : '';
                const noteBody = typeof n.body === 'string' ? n.body : '';
                const preview = noteBody.length > 140 ? (noteBody.slice(0, 140) + '...') : noteBody;
                const focusLabel = n.id === focusedId ? 'Unfocus' : 'Focus';
                return `<div class="note-card ${n.id === activeId ? 'active' : ''} ${n.id === focusedId ? 'focused' : ''}" onclick="openNote(${n.id})">
                    ${citationHtml}
                    <div class="note-body">${escapeHtml(preview)}</div>
                    <div class="note-meta">
                        <span>${n.section ? escapeHtml(n.section) : ''} ${time}</span>
                        <span>
                            <button class="note-focus" onclick="toggleFocusNote(${n.id}, event)">${focusLabel}</button>
                            <button class="note-delete" onclick="deleteNote(${n.id}, event)">Delete</button>
                        </span>
                    </div>
                </div>`;
            }).join('');
            renderNoteReader(sortedNotes);
        }
        
        function exportNotesToObsidian() {
            const notes = loadNotes();
            if (notes.length === 0) { alert('No notes to export.'); return; }
            
            const title = document.title.replace(' - Interactive Learning', '');
            const sourceFile = document.querySelector('.main-content header p')?.textContent?.match(/Source: (.+)/)?.[1] || '';
            
            let md = `---
tags: [lecture-notes, mfin7034]
source: "${sourceFile}"
date: ${new Date().toISOString().split('T')[0]}
---

`;
            md += `# ${title}

`;
            md += `> [!info] Source
> PDF: [[${sourceFile.replace('.pdf','')}]]

`;
            
            notes.forEach((n, idx) => {
                if (n.citation) {
                    md += `> [!quote] Highlight
> ${n.citation}

`;
                }
                const noteBody = typeof n.body === 'string' ? n.body : '';
                md += noteBody + `

`;
                if (idx < notes.length - 1) md += `---

`;
            });
            
            md += `
## References

- Source: ${sourceFile}
- Generated: ${new Date().toLocaleString()}
`;
            
            const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = title.replace(/[^a-zA-Z0-9一-鿿 ]/g, '_') + '.md';
            a.click();
            URL.revokeObjectURL(a.href);
        }
        
        // ── Text Highlight & Selection ──
        const highlightTooltip = document.createElement('div');
        highlightTooltip.className = 'highlight-tooltip';
        highlightTooltip.innerHTML = `
            <button onclick="highlightSelection()">Highlight</button>
            <button onclick="highlightAndNote()">+ Note</button>
        `;
        document.body.appendChild(highlightTooltip);
        
        document.addEventListener('mouseup', (e) => {
            const sel = window.getSelection();
            const text = sel.toString().trim();
            
            // Only show for selections within main content
            const main = document.querySelector('.main-content');
            if (!text || text.length < 3 || !main?.contains(sel.anchorNode)) {
                highlightTooltip.classList.remove('show');
                return;
            }
            
            const range = sel.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            highlightTooltip.style.left = rect.left + (rect.width / 2) - 60 + 'px';
            highlightTooltip.style.top = rect.top - 40 + window.scrollY + 'px';
            highlightTooltip.classList.add('show');
        });
        
        document.addEventListener('mousedown', (e) => {
            if (!highlightTooltip.contains(e.target)) {
                highlightTooltip.classList.remove('show');
            }
        });
        
        function highlightSelection() {
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            const mark = document.createElement('mark');
            mark.className = 'text-highlight';
            try {
                range.surroundContents(mark);
            } catch(e) {
                // Cross-element selection: fall back
                const text = sel.toString();
                mark.textContent = text;
                range.deleteContents();
                range.insertNode(mark);
            }
            sel.removeAllRanges();
            highlightTooltip.classList.remove('show');
        }
        
        function highlightAndNote() {
            const sel = window.getSelection();
            const text = sel.toString().trim();
            if (!text) return;
            
            // Find section context
            let section = '';
            let node = sel.anchorNode;
            while (node && node !== document.body) {
                if (node.classList?.contains('concept-section')) {
                    const h2 = node.querySelector('h2');
                    if (h2) section = h2.textContent;
                    break;
                }
                node = node.parentNode;
            }
            
            highlightSelection();
            
            openInlineSelectionNoteEditor(text, section, sel.getRangeAt(0).getBoundingClientRect());
        }
        

        function closeInlineSelectionNoteEditor() {
            document.getElementById('inlineSelectionNoteEditor')?.remove();
        }

        function openInlineSelectionNoteEditor(selectionText, section, rect) {
            closeInlineSelectionNoteEditor();
            const editor = document.createElement('div');
            editor.id = 'inlineSelectionNoteEditor';
            editor.style.position = 'absolute';
            editor.style.zIndex = '10030';
            editor.style.width = 'min(420px, 90vw)';
            editor.style.background = 'var(--bg-card)';
            editor.style.border = '1px solid var(--border-color)';
            editor.style.borderRadius = '12px';
            editor.style.boxShadow = '0 16px 36px rgba(0,0,0,0.32)';
            editor.style.padding = '0.65rem';
            editor.style.top = (window.scrollY + rect.bottom + 10) + 'px';
            editor.style.left = Math.max(12, Math.min(window.scrollX + rect.left, window.scrollX + window.innerWidth - 440)) + 'px';
            editor.innerHTML = `
                <div style="font-size:0.78rem;color:var(--text-tertiary);margin-bottom:0.4rem;">Add note for selection</div>
                <textarea id="inlineSelectionNoteInput" placeholder="Write note... (Markdown supported)" style="width:100%;min-height:88px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:8px;padding:0.5rem;font-size:0.86rem;resize:vertical;"></textarea>
                <div style="display:flex;justify-content:flex-end;gap:0.45rem;margin-top:0.45rem;">
                    <button type="button" id="inlineSelectionNoteCancel" style="border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);border-radius:8px;padding:0.3rem 0.6rem;cursor:pointer;font-size:0.8rem;">Cancel</button>
                    <button type="button" id="inlineSelectionNoteSave" style="border:1px solid rgba(163,217,165,.55);background:var(--bg-elevated);color:var(--accent-secondary);border-radius:8px;padding:0.3rem 0.6rem;cursor:pointer;font-size:0.8rem;">Save</button>
                </div>
            `;
            document.body.appendChild(editor);
            const input = editor.querySelector('#inlineSelectionNoteInput');
            input?.focus();
            editor.querySelector('#inlineSelectionNoteCancel')?.addEventListener('click', closeInlineSelectionNoteEditor);
            editor.querySelector('#inlineSelectionNoteSave')?.addEventListener('click', () => {
                const body = (input?.value || '').trim() || '(highlighted)';
                addNote(selectionText, body, section);
                closeInlineSelectionNoteEditor();
            });
        }

        // ── Init ──
        document.addEventListener('DOMContentLoaded', () => {
            new LearningPageController();
            
            // Add reveal animation to concept sections
            document.querySelectorAll('.feynman-block, .quiz-container, .expandable, .chart-container, .diagram-container, .comparison-block, .stats-grid').forEach(el => {
                el.classList.add('reveal-on-scroll');
            });
            
            // Re-init observer for dynamically added elements
            const obs = new IntersectionObserver((entries) => {
                entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('revealed'); });
            }, { threshold: 0.08 });
            document.querySelectorAll('.reveal-on-scroll').forEach(el => obs.observe(el));
            
            // Initialize note draft autosave + live markdown preview
            initNoteComposer();
            // Load saved notes
            renderNotes();
        });
        
        // Typing dots animation
        const typingStyle = document.createElement('style');
        typingStyle.textContent = `
            .typing-dots span {
                animation: blink 1.4s infinite;
                font-size: 1.5em;
                line-height: 1;
            }
            .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
            .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
            @keyframes blink {
                0%, 60%, 100% { opacity: 0.2; }
                30% { opacity: 1; }
            }
        `;
        document.head.appendChild(typingStyle);
    
    </script>
    
    <!-- KaTeX auto-render -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\(", right: "\\)", display: false},
                        {left: "\\[", right: "\\]", display: true}
                    ],
                    throwOnError: false
                });
            }
        });
    </script>
    <script src="./app-shell.js?v=12"></script>
    <script src="./lecture-enhancements.js?v=7"></script>
</body>
</html>