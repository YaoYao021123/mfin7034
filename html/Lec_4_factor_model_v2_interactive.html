<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lec 4 factor model v2 - Interactive Learning</title>
    
    <!-- KaTeX for formula rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    
    <!-- Mermaid for flowcharts and diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    
    <!-- Fonts: Noto Serif for body, Inter for headings -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        
        :root {
            /* Warm Academic Theme - Clean & Readable */
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #1f2b47;
            --bg-elevated: #263352;
            --bg-card: #1c2a45;
            
            --text-primary: #edf2f7;
            --text-secondary: #a0aec0;
            --text-tertiary: #718096;
            
            /* Warm Gold + Sage Green palette */
            --accent-primary: #f6c177;
            --accent-secondary: #a3d9a5;
            --accent-tertiary: #c4b5fd;
            --accent-warning: #fbbf24;
            --accent-error: #fb7185;
            --accent-info: #7dd3fc;
            
            --gradient-primary: linear-gradient(135deg, #f6c177 0%, #e8a87c 100%);
            --gradient-heading: linear-gradient(135deg, #f6c177 0%, #c4b5fd 100%);
            
            --border-color: rgba(255, 255, 255, 0.06);
            --border-hover: rgba(246, 193, 119, 0.25);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.25);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.4);
            
            --font-body: 'Georgia', 'Times New Roman', 'Noto Serif SC', serif;
            --font-heading: -apple-system, 'Helvetica Neue', 'PingFang SC', sans-serif;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', monospace;
            
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            
            --ease: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #faf8f5;
                --bg-secondary: #f0ece4;
                --bg-tertiary: #e8e2d8;
                --bg-elevated: #ffffff;
                --bg-card: #ffffff;
                
                --text-primary: #1c1917;
                --text-secondary: #57534e;
                --text-tertiary: #a8a29e;
                
                --accent-primary: #c2742f;
                --accent-secondary: #3d8b40;
                --accent-tertiary: #7c3aed;
                --accent-warning: #b45309;
                --accent-error: #dc2626;
                
                --gradient-heading: linear-gradient(135deg, #c2742f 0%, #7c3aed 100%);
                
                --border-color: rgba(0, 0, 0, 0.06);
                --border-hover: rgba(194, 116, 47, 0.3);
                --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.06);
                --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
                --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
            }
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.8;
            overflow-x: hidden;
        }
        
        .page-container {
            --left-width: 260px;
            --right-width: 300px;
            display: grid;
            grid-template-columns: minmax(200px, var(--left-width)) 8px minmax(0, 1fr) 8px minmax(220px, var(--right-width));
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .column-resizer {
            cursor: col-resize;
            background: transparent;
            transition: background-color 0.15s var(--ease);
            position: sticky;
            top: 0;
            height: 100vh;
            z-index: 5;
        }
        .column-resizer:hover,
        .column-resizer.dragging {
            background: rgba(246, 193, 119, 0.2);
        }
        
        .sidebar-left, .sidebar-right {
            background: var(--bg-secondary);
            padding: 2rem 1.25rem;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
        
        .sidebar-left {
            border-right: 1px solid var(--border-color);
        }
        
        .sidebar-right {
            border-left: 1px solid var(--border-color);
        }
        
        .main-content {
            max-width: none;
            min-width: 0;
            width: 100%;
            margin: 0 auto;
            padding: 3rem 2.5rem;
        }
        
        @media (max-width: 1200px) {
            .page-container { grid-template-columns: 1fr; }
            .sidebar-left, .sidebar-right, .column-resizer { display: none; }
            .main-content { padding: 2rem 1.25rem; }
        }
        
        h1 {
            font-family: var(--font-heading);
            font-size: clamp(1.875rem, 4vw, 2.5rem);
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 0.75rem;
            letter-spacing: -0.01em;
            color: var(--text-primary);
        }
        
        h2 {
            font-family: var(--font-heading);
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 3.5rem;
            margin-bottom: 1.25rem;
            color: var(--accent-primary);
            letter-spacing: -0.01em;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        h3 {
            font-family: var(--font-heading);
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        
        h4 {
            font-family: var(--font-heading);
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
        
        h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        p {
            margin-bottom: 1rem;
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.8;
        }
        
        .feynman-block {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-left: 3px solid var(--accent-primary);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 1.5rem 0;
            transition: border-color 0.2s var(--ease);
        }
        
        .feynman-block:hover {
            border-color: var(--border-hover);
        }
        
        .feynman-block .icon {
            font-size: 1.75rem;
            margin-bottom: 0.75rem;
            display: inline-block;
        }
        
        .expandable {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            margin: 1.5rem 0;
            overflow: hidden;
        }
        
        .expandable-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            cursor: pointer;
            user-select: none;
            font-weight: 500;
            font-family: var(--font-heading);
            transition: background 0.15s var(--ease);
        }
        
        .expandable-header:hover {
            background: var(--bg-tertiary);
        }
        
        .expandable-icon {
            transition: transform 0.25s var(--ease);
            display: inline-block;
            font-size: 0.8rem;
        }
        
        .expandable.open .expandable-icon {
            transform: rotate(180deg);
        }
        
        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s var(--ease);
        }
        
        .expandable.open .expandable-content {
            max-height: 5000px;
        }
        
        .expandable-content-inner {
            padding: 1.25rem;
            border-top: 1px solid var(--border-color);
        }
        
        .quiz-container {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 2rem 0;
            border: 1px solid var(--border-color);
        }
        
        .quiz-question {
            font-size: 1.05rem;
            font-family: var(--font-heading);
            margin-bottom: 1.25rem;
            color: var(--text-primary);
        }
        
        .quiz-options {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }
        
        .quiz-option {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.15s var(--ease);
            font-size: 0.95rem;
        }
        
        .quiz-option:hover {
            border-color: var(--accent-primary);
            padding-left: 1.25rem;
        }
        
        .quiz-option.correct {
            background: rgba(163, 217, 165, 0.2);
            border-color: var(--accent-secondary);
            color: var(--accent-secondary);
        }
        
        .quiz-option.incorrect {
            background: rgba(251, 113, 133, 0.15);
            border-color: var(--accent-error);
            color: var(--accent-error);
        }
        
        .quiz-feedback {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-sm);
            display: none;
            font-size: 0.9rem;
        }
        
        .quiz-feedback.show { display: block; }
        .quiz-feedback.correct { background: rgba(163, 217, 165, 0.15); border: 1px solid var(--accent-secondary); }
        .quiz-feedback.incorrect { background: rgba(251, 113, 133, 0.1); border: 1px solid var(--accent-error); }
        
        .progress-tracker {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--bg-secondary);
            z-index: 1000;
        }
        
        .progress-bar {
            height: 100%;
            background: var(--gradient-primary);
            width: 0%;
            transition: width 0.2s var(--ease);
        }
        
        .ai-chat {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: 1.25rem;
        }
        
        .ai-chat-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .ai-chat-messages {
            max-height: 320px;
            overflow-y: auto;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
        }
        
        .ai-message {
            margin-bottom: 0.75rem;
            padding: 0.625rem 0.875rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            line-height: 1.6;
        }
        
        .ai-message.user {
            background: var(--accent-primary);
            color: var(--bg-primary);
            margin-left: 1.5rem;
            font-weight: 500;
        }
        
        .ai-message.assistant {
            background: var(--bg-tertiary);
            margin-right: 1.5rem;
        }
        
        .ai-input-group { display: flex; gap: 0.5rem; }
        
        .ai-input {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.625rem 0.75rem;
            color: var(--text-primary);
            font-family: var(--font-body);
            font-size: 0.875rem;
        }
        
        .ai-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }
        
        .ai-send-btn, .action-btn {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            border-radius: var(--radius-sm);
            padding: 0.625rem 1rem;
            cursor: pointer;
            font-weight: 600;
            font-family: var(--font-heading);
            font-size: 0.85rem;
            transition: opacity 0.15s;
        }
        
        .action-btn {
            width: 100%;
            margin-bottom: 0.5rem;
            text-align: left;
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }
        
        .ai-send-btn:hover { opacity: 0.85; }
        .action-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        
        kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.15rem 0.5rem;
            font-family: var(--font-mono);
            font-size: 0.8em;
        }
        
        .toc-link {
            color: var(--text-secondary);
            text-decoration: none;
            display: block;
            padding: 0.375rem 0.5rem;
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-family: var(--font-heading);
            transition: color 0.15s, background 0.15s;
        }
        
        .toc-link:hover {
            color: var(--accent-primary);
            background: var(--bg-tertiary);
        }
        
        /* Scroll reveal - simple fade */
        .reveal-on-scroll {
            opacity: 0;
            transform: translateY(16px);
            transition: opacity 0.5s var(--ease), transform 0.5s var(--ease);
        }
        .reveal-on-scroll.revealed {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--bg-elevated); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-tertiary); }
        
        ::selection { background: var(--accent-primary); color: var(--bg-primary); }
        
        /* Print */
        @media print {
            .sidebar-left, .sidebar-right, .progress-tracker { display: none; }
            .page-container { grid-template-columns: 1fr; }
            body { background: white; color: black; }
        }
        
        /* ===========================================
           DATA VISUALIZATION & CHARTS
           =========================================== */
        .chart-container {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }
        .chart-container .chart-title {
            font-family: var(--font-heading);
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            text-align: center;
        }
        .chart-container canvas { max-height: 380px; width: 100% !important; }
        .chart-caption {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            text-align: center;
            margin-top: 0.75rem;
            font-style: italic;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        .chart-grid .chart-container { margin: 0; }
        
        .diagram-container {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow-x: auto;
            text-align: center;
        }
        .diagram-container .diagram-title {
            font-family: var(--font-heading);
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }
        .diagram-container .mermaid { display: flex; justify-content: center; }
        .diagram-container .mermaid svg { max-width: 100%; height: auto; }
        .diagram-caption {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            text-align: center;
            margin-top: 0.75rem;
            font-style: italic;
        }
        
        .comparison-block {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: stretch;
            margin: 2rem 0;
        }
        .comparison-side {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .comparison-side.left { border-top: 3px solid var(--accent-primary); }
        .comparison-side.right { border-top: 3px solid var(--accent-secondary); }
        .comparison-side h4 { margin-bottom: 0.75rem; }
        .comparison-side ul { padding-left: 1.25rem; }
        .comparison-side li { margin-bottom: 0.5rem; color: var(--text-secondary); font-size: 0.95rem; }
        .comparison-divider {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            color: var(--text-tertiary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        .stat-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: transform 0.15s var(--ease);
        }
        .stat-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-primary);
            display: block;
            font-family: var(--font-heading);
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 0.25rem;
        }
        
        @media (max-width: 768px) {
            .comparison-block { grid-template-columns: 1fr; }
            .comparison-divider { justify-content: center; padding: 0.5rem 0; }
            .chart-grid { grid-template-columns: 1fr; }
        }
        
        /* ===========================================
           SIDEBAR TABS & PANELS
           =========================================== */
        .sidebar-tabs {
            display: flex;
            gap: 2px;
            margin-bottom: 1rem;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            padding: 2px;
        }
        .sidebar-tab {
            flex: 1;
            padding: 0.5rem 0.25rem;
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-family: var(--font-heading);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.15s var(--ease);
        }
        .sidebar-tab:hover { color: var(--text-secondary); }
        .sidebar-tab.active {
            background: var(--bg-elevated);
            color: var(--accent-primary);
        }
        
        /* ===========================================
           NOTES SYSTEM
           =========================================== */
        .note-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: 0.625rem;
            font-size: 0.85rem;
            position: relative;
            cursor: pointer;
            transition: border-color 0.15s var(--ease), transform 0.15s var(--ease);
        }
        .note-card:hover { border-color: var(--border-hover); }
        .note-card.active {
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }
        .note-card.focused {
            border-left: 3px solid var(--accent-secondary);
            padding-left: calc(0.625rem - 2px);
        }
        .note-card .note-citation {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            border-left: 2px solid var(--accent-primary);
            padding-left: 0.5rem;
            margin-bottom: 0.375rem;
            font-style: italic;
            line-height: 1.4;
        }
        .note-card .note-body {
            color: var(--text-secondary);
            line-height: 1.5;
        }
        .note-card .note-meta {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            margin-top: 0.375rem;
            display: flex;
            justify-content: space-between;
        }
        .note-card .note-delete {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0;
        }
        .note-card .note-delete:hover { color: var(--accent-error); }
        .note-card .note-focus {
            background: none;
            border: none;
            color: var(--accent-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 0;
            margin-right: 0.5rem;
        }
        .note-card .note-focus:hover { color: var(--accent-primary); }
        .note-reader {
            margin-top: 0.75rem;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background: var(--bg-primary);
            overflow-y: auto;
            max-height: 34vh;
        }
        .note-reader .reader-title {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
        }
        .note-reader .reader-content {
            color: var(--text-secondary);
            line-height: 1.65;
            font-size: 0.9rem;
        }
        .note-reader .reader-content code {
            background: var(--bg-tertiary);
            padding: 0.1em 0.35em;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .note-draft-preview {
            margin-top: 0.5rem;
            max-height: 20vh;
        }
        
        /* ===========================================
           TEXT HIGHLIGHT
           =========================================== */
        .text-highlight {
            background: rgba(246, 193, 119, 0.25);
            border-bottom: 2px solid var(--accent-primary);
            cursor: pointer;
            transition: background 0.15s;
        }
        .text-highlight:hover {
            background: rgba(246, 193, 119, 0.4);
        }
        
        /* Highlight context menu */
        .highlight-tooltip {
            position: fixed;
            background: var(--bg-elevated);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow-lg);
            padding: 0.25rem;
            display: none;
            z-index: 1001;
            gap: 2px;
        }
        .highlight-tooltip.show { display: flex; }
        .highlight-tooltip button {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.375rem 0.625rem;
            cursor: pointer;
            font-size: 0.8rem;
            font-family: var(--font-heading);
            border-radius: 4px;
            white-space: nowrap;
        }
        .highlight-tooltip button:hover {
            background: var(--bg-tertiary);
            color: var(--accent-primary);
        }
    
    </style>
    <link rel="stylesheet" href="./app-shell.css?v=10" />
</head>
<body data-shell-page="lecture">
    <!-- Progress Tracker -->
    <div class="progress-tracker">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="page-container">
        <!-- Left Sidebar -->
        <aside class="sidebar-left">
            <!-- Sidebar Tabs -->
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" data-tab="toc" onclick="switchSidebarTab('toc')">Contents</button>
                <button class="sidebar-tab" data-tab="pdf" onclick="switchSidebarTab('pdf')">PDF</button>
                <button class="sidebar-tab" data-tab="notes" onclick="switchSidebarTab('notes')">Notes</button>
            </div>
            
            <!-- Tab: Table of Contents -->
            <div class="sidebar-panel" id="panel-toc">
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 0.75rem;">
                        <a href="#overview" class="toc-link">Overview</a>
                    </li>
                    
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-1" class="toc-link">Efficient Market Hypothesis (EMH)</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-2" class="toc-link">Random Walk Theory</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-3" class="toc-link">Sharpe Ratio</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-4" class="toc-link">Capital Asset Pricing Model (CAPM)</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-5" class="toc-link">Alpha and Beta</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-6" class="toc-link">Risk Premium</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-7" class="toc-link">Diversification</a>
            </li>
        
            <li style="margin-bottom: 0.75rem;">
                <a href="#concept-8" class="toc-link">Idiosyncratic vs. Systematic Risk</a>
            </li>
        
                </ul>
                
                <div style="margin-top: 3rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.85rem;">
                    <div style="color: var(--text-tertiary); margin-bottom: 0.5rem;">Course Stats</div>
                    <div style="color: var(--text-secondary);">
                        <div>8 Concepts</div>
                        <div>15 Images</div>
                        <div>37 Tables</div>
                    </div>
                </div>
            </div>
            
            <!-- Tab: PDF Viewer -->
            <div class="sidebar-panel" id="panel-pdf" style="display:none;">
                <div id="pdfViewerContainer" style="height: calc(100vh - 80px); display: flex; flex-direction: column;">
                    <p style="font-size: 0.85rem; color: var(--text-tertiary); margin-bottom: 0.75rem;">Source: Lec 4 factor model v2.pdf</p>
                    <iframe id="pdfFrame" src="../pdfs/Lec 4 factor model v2.pdf" style="flex:1; width:100%; border:none; border-radius: var(--radius-sm); background: var(--bg-tertiary);"></iframe>
                </div>
            </div>
            
            <!-- Tab: Notes -->
            <div class="sidebar-panel" id="panel-notes" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                    <span style="font-size: 0.85rem; color: var(--text-tertiary);" id="notesCount">0 notes</span>
                    <button onclick="exportNotesToObsidian()" class="action-btn" style="width:auto; padding: 0.4rem 0.75rem; font-size: 0.8rem;">Export .md</button>
                </div>
                <div id="notesList" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 32vh; overflow-y: auto;"></div>
                <div id="noteReader" class="note-reader">
                    <div class="reader-title">Reading</div>
                    <div class="reader-content">Click a note in history to read it here.</div>
                </div>
                <div style="margin-top: 0.75rem; border-top: 1px solid var(--border-color); padding-top: 0.75rem;">
                    <textarea id="noteInput" oninput="handleNoteInputChange(this.value)" placeholder="Write a note (Markdown supported)..." style="width:100%; min-height: 80px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-sm); padding: 0.5rem; color: var(--text-primary); font-family: var(--font-mono); font-size: 0.85rem; resize: vertical;"></textarea>
                    <div id="noteDraftPreview" class="note-reader note-draft-preview">
                        <div class="reader-title">Live Preview</div>
                        <div class="reader-content" id="noteDraftPreviewContent">Type in the note box to preview Markdown rendering in real time.</div>
                    </div>
                    <button onclick="addFreeNote()" class="action-btn" style="margin-top: 0.375rem;">Add Note</button>
                </div>
            </div>
        </aside>

        <div class="column-resizer" id="resizerLeft" role="separator" aria-orientation="vertical" aria-label="Resize left sidebar"></div>

        <!-- Main Content -->
        <main class="main-content">
            <header id="overview">
                <h1>Lec 4 factor model v2</h1>
                <p style="font-size: 1.1rem; color: var(--text-tertiary); margin-bottom: 2rem;">
                    Interactive Learning Experience • Source: Lec 4 factor model v2.pdf
                </p>
                
                <!-- Course Overview -->
                <div class="feynman-block" style="border-left-color: #9f7aea;">
                    <h4>Course Overview</h4>
                    <p><strong>Difficulty:</strong> Intermediate</p>
                    
                    <h5 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--accent-primary);">Prerequisites:</h5>
                    <ul style="margin-left: 1.5rem;">
                        <li>Basic Statistics (Mean, Variance, Standard Deviation)</li><li>Introductory Probability Theory</li><li>Fundamental understanding of Financial Markets and Securities</li><li>Basic Linear Regression Analysis</li>
                    </ul>
                    
                    <h5 style="margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--accent-secondary);">Learning Objectives:</h5>
                    <ul style="margin-left: 1.5rem;">
                        <li>Differentiate between market efficiency and the potential for abnormal returns through mispricing or risk premiums.</li><li>Calculate and interpret the Sharpe Ratio to evaluate the performance of different trading strategies.</li><li>Apply the CAPM formula to decompose asset returns into systematic (market) and idiosyncratic components.</li><li>Explain why diversification is essential for reducing risk without necessarily sacrificing expected market returns.</li>
                    </ul>
                </div>
            </header>

            <!-- Concept Sections -->
            
        <section id="concept-1" class="concept-section">
            <h2>Efficient Market Hypothesis (EMH)</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Think of a busy sidewalk where thousands of people pass by every minute. If a $20 bill were lying on the ground, someone would have already picked it up before you ever saw it; similarly, 'undervalued' stocks are grabbed by professional traders the moment they appear, leaving no 'free money' for latecomers.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>EMH is the logical foundation for passive investing and index funds, suggesting that for most people, trying to 'pick winners' is a waste of time and fees. It shifts the investor's focus from outsmarting the market to managing long-term risk and diversification.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="diagram-container">
            <div class="diagram-title">The Information-to-Price Cycle</div>
            <div class="mermaid">
flowchart LR
    A[New Information/News] --> B[Massive Competition]
    B --> C[Instant Trading Activity]
    C --> D[Price Adjusts to Fair Value]
    D --> E[No Excess Profit Opportunity]
    E --> A
            </div>
            <div class="diagram-caption">How EMH suggests information is instantly absorbed into market value.</div>
        </div>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>The Efficient Market Hypothesis suggests that because millions of participants are constantly analyzing and trading assets to make a profit, the market acts as a giant processing engine. This collective competition ensures that any new information—whether it's an earnings report, a political event, or a change in interest rates—is reflected in the stock price almost instantly. Consequently, prices only move in response to 'news,' which is by definition unpredictable. This results in a 'random walk' of price movements, meaning that neither studying past charts nor analyzing public financial statements can give an investor a consistent edge over a simple market-average strategy.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>The theory that asset prices reflect all available information, making it extremely difficult to consistently 'beat the market' or predict future price movements.</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>If a pharmaceutical company unexpectedly announces a successful FDA trial at 10:00 AM, high-frequency algorithms and professional traders buy the stock within milliseconds. By 10:01 AM, the price has already jumped from $50 to $70. An individual investor who reads the news at 10:15 AM and buys at $70 hasn't 'beaten' the market; they have simply paid the new fair price that already accounts for the success.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Students often assume EMH means that market prices are always 'right' or 'accurate' representations of a company's true future value. In reality, EMH only claims prices are 'efficient' relative to available information; the market can be completely wrong about the future, but you cannot know how it is wrong until new information arrives.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> According to the Efficient Market Hypothesis (EMH), why is it considered extremely difficult for investors to consistently 'beat the market'?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Market volatility makes it impossible to trade frequently.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Stock prices already incorporate and reflect all available information.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        High transaction fees consume all potential profit margins.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Government regulations prevent individual investors from gaining an advantage.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The EMH suggests that because all known information is already baked into stock prices, no investor has an information advantage to consistently outperform the general market.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The EMH suggests that because all known information is already baked into stock prices, no investor has an information advantage to consistently outperform the general market.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> Which of the following statements best aligns with the core philosophy of the Efficient Market Hypothesis?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Expert researchers can easily find undervalued stocks that others missed.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Past price trends are the most reliable indicators of future performance.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Asset prices always trade at their fair value on stock exchanges.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Investors are generally irrational and drive prices away from their true value.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! A central tenet of EMH is that stocks always trade at their fair market value, making it impossible to reliably purchase undervalued stocks or sell them at inflated prices.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. A central tenet of EMH is that stocks always trade at their fair market value, making it impossible to reliably purchase undervalued stocks or sell them at inflated prices.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> In an efficient market, what happens to the price of a stock when new, unexpected information about a company is released?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="true">
                        The price adjusts almost instantly to reflect the new information.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The price remains stable until the next quarterly earnings report.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The price takes several weeks to fully reflect the news as investors react.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The price only changes if the news is reported by major media outlets.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! EMH posits that markets are so efficient that new information is absorbed and reflected in the asset price immediately, leaving no window for investors to profit from the news after it breaks.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. EMH posits that markets are so efficient that new information is absorbed and reflected in the asset price immediately, leaving no window for investors to profit from the news after it breaks.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-2" class="concept-section">
            <h2>Random Walk Theory</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Imagine a blindfolded person standing in the center of a field who takes one step every minute in a direction determined solely by a coin toss. Because each step is decided by a new toss, knowing where they walked a minute ago gives you zero clues about which direction they will move next.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>This theory suggests that consistently 'beating the market' through technical analysis is statistically impossible because past price patterns don't repeat. It serves as the foundation for the Efficient Market Hypothesis and the widespread use of passive index funds rather than active stock picking.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="chart-container">
            <div class="chart-title">Simulated Random Walk vs. Deterministic Trend</div>
            <canvas id="chart-2" style="max-height:380px;"></canvas>
            <div class="chart-caption">The blue line shows how random steps create 'fake' trends and patterns that have no predictive power.</div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('chart-2');
            if (ctx && typeof Chart !== 'undefined') {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ["Day 1", "Day 5", "Day 10", "Day 15", "Day 20", "Day 25", "Day 30"],
                        datasets: [{"label": "Stock Price (Random Walk)", "data": [100, 102, 101, 105, 104, 108, 107], "borderColor": "#4299e1", "backgroundColor": "rgba(66,153,225,0.15)", "tension": 0.4, "fill": true}]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { color: 'rgba(255,255,255,0.05)' } }
            }
                    }
                });
            }
        });
        </script>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Random Walk Theory asserts that stock price movements are independent and identically distributed (i.i.d.) variables. In an efficient market, prices instantly reflect all available information; since news arrives unpredictably, price changes must also be unpredictable. Mathematically, the price at time (t+1) is simply the price at time (t) plus a random error term with a mean of zero. This implies that the 'memory' of the market is zero, rendering historical trends irrelevant for forecasting. While prices may trend upward over years due to economic growth, their day-to-day fluctuations are purely stochastic noise that cannot be exploited for profit.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>A mathematical view of stock prices where future price changes are random and independent of past movements, visualized as oscillations around a mean.</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>If Stock X is trading at $100 today, a follower of Random Walk Theory believes there is roughly a 50/50 chance it will move up or down tomorrow, regardless of whether it rose for the last ten days straight. If the stock hits $105 tomorrow, that $5 gain is treated as a random event triggered by new information, not a 'momentum' trend. Even after 30 days of trading, the final price is just the sum of 30 individual, unrelated random shocks added to the starting price of $100.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Many students mistake 'random' for 'meaningless' or 'stationary,' assuming the price must always return to a specific average. In reality, a random walk can drift very far from its starting point over time, creating patterns that look like trends to the human eye but are actually statistically coincidental.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> What is the core premise of Random Walk Theory regarding stock price movements?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Future prices can be predicted by analyzing historical volume trends.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Stock prices follow a predetermined path based on seasonal cycles.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Future price changes are random and independent of any past movements.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Market prices are always dictated by the fundamental value of a company.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Random Walk Theory suggests that price changes are stochastic and cannot be predicted using historical data because each movement is independent.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Random Walk Theory suggests that price changes are stochastic and cannot be predicted using historical data because each movement is independent.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> How does Random Walk Theory characterize the relationship between a stock's past performance and its future price?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Past performance is the most reliable indicator of future returns.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Past movements have no influence or predictive power over future changes.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Stocks have a 'memory' that causes them to repeat patterns every decade.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Negative past performance guarantees a positive future correction.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The theory posits that because price changes are independent, looking at past trends provides no statistical advantage for forecasting future prices.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The theory posits that because price changes are independent, looking at past trends provides no statistical advantage for forecasting future prices.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> In a mathematical model of a Random Walk, how are stock price movements typically visualized?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        As a straight line showing constant growth.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        As a series of parabolic curves that never overlap.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        As oscillations or fluctuations around a mean value.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        As a staircase pattern that only moves in fixed increments.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Random Walk Theory visualizes stock prices as random oscillations around a central mean, reflecting the unpredictable nature of market fluctuations.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Random Walk Theory visualizes stock prices as random oscillations around a central mean, reflecting the unpredictable nature of market fluctuations.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-3" class="concept-section">
            <h2>Sharpe Ratio</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Think of the Sharpe Ratio as a 'bang for your buck' score for risk. It’s like comparing two jobs: one pays $100k but is incredibly stressful and unstable, while another pays $80k and is very calm; the Sharpe Ratio tells you which one gives you more 'bonus pay' for every 'unit of stress' you endure compared to a basic, stress-free job.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>It allows investors to compare different assets on a level playing field, revealing if a portfolio's high returns are due to skill or simply taking on dangerous amounts of risk. It is the industry standard for determining whether the 'pain' of price swings is actually worth the financial 'gain.'</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="chart-container">
            <div class="chart-title">Sharpe Ratio: Reward vs. Risk Efficiency</div>
            <canvas id="chart-3" style="max-height:380px;"></canvas>
            <div class="chart-caption">Investment B is superior because it offers a higher return relative to the risk taken (higher Sharpe Ratio).</div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('chart-3');
            if (ctx && typeof Chart !== 'undefined') {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ["Investment A (Aggressive)", "Investment B (Efficient)"],
                        datasets: [{"label": "Sharpe Ratio (Return per Unit of Risk)", "data": [0.65, 1.6], "borderColor": "#4299e1", "backgroundColor": "rgba(66,153,225,0.15)"}]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { color: 'rgba(255,255,255,0.05)' } }
            }
                    }
                });
            }
        });
        </script>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>The Sharpe Ratio calculates the 'excess return' an investor earns for the extra risk they take on. To find it, you first take the total return of an investment and subtract the 'risk-free rate' (the return you'd get from a guaranteed source like a government bond), leaving you with the profit earned specifically from taking a gamble. You then divide this extra profit by the investment's volatility, or standard deviation. This result provides a single number representing how much reward you receive for every unit of uncertainty you stomach; the higher the number, the more efficiently the investment is performing relative to its risk.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>
p Var ( R ).

•  Sharpe Ratio (SR) is defined as:
SR  :=   E [ R ]  − r f


[FORMULA]: σ

, where  r f  is the risk free rate. 7


[Tables on this page: 1]</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Suppose Portfolio A returns 15% with a risk level (volatility) of 20%, while Portfolio B returns 10% with a risk level of only 5%. If the risk-free rate is 2%, Portfolio A’s ratio is 0.65, but Portfolio B’s ratio is 1.6. Even though Portfolio A has a higher total return, Portfolio B is the smarter investment because it delivers more than double the reward for every unit of risk involved.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Students often mistakenly use the total return in the numerator instead of subtracting the risk-free rate, which fails to isolate the actual 'premium' earned for taking risk. Additionally, many forget that the ratio is based on historical data, which may not accurately predict how volatile or profitable an asset will be in the future.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> In the formula for the Sharpe Ratio, what does the numerator (E[R] - rf) represent?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        The total volatility of the portfolio
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        The excess return over the risk-free rate
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The benchmark index performance
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The risk-adjusted capital allocation
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The numerator calculates the return earned by an investment above the return of a risk-free asset.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The numerator calculates the return earned by an investment above the return of a risk-free asset.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> What does the denominator (σ) represent in the Sharpe Ratio calculation?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        The expected return of the market
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The risk-free interest rate
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        The standard deviation of the asset's excess return
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The variance of the risk-free rate
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The denominator σ represents the standard deviation, which measures the volatility or risk of the investment's returns.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The denominator σ represents the standard deviation, which measures the volatility or risk of the investment's returns.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> If Portfolio A has an expected return of 12%, a risk-free rate of 2%, and a standard deviation of 5%, what is its Sharpe Ratio?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="true">
                        2.0
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        2.4
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        1.0
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        0.5
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Using the formula (E[R] - rf) / σ, the calculation is (12 - 2) / 5, which equals 2.0.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Using the formula (E[R] - rf) / σ, the calculation is (12 - 2) / 5, which equals 2.0.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-4" class="concept-section">
            <h2>Capital Asset Pricing Model (CAPM)</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Think of the risk-free rate as a guaranteed base salary for a safe desk job. If you choose a commission-based sales job instead, your 'Beta' represents how sensitive your income is to the overall economy; you only accept the extra stress if the potential payout increases proportionally with that economic risk.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>CAPM is the industry standard for calculating the cost of equity, helping companies decide if a project's potential return justifies its risk. For investors, it provides a benchmark to judge if a stock is 'overvalued' or 'undervalued' based on its contribution to a diversified portfolio's risk.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="chart-container">
            <div class="chart-title">The Security Market Line (SML)</div>
            <canvas id="chart-4" style="max-height:380px;"></canvas>
            <div class="chart-caption">This graph shows how expected return increases linearly as Beta (systematic risk) increases, starting from the risk-free rate.</div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('chart-4');
            if (ctx && typeof Chart !== 'undefined') {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ["0 (Risk-Free)", "0.5", "1.0 (Market)", "1.5", "2.0"],
                        datasets: [{"label": "Expected Return (%)", "data": [3, 6.5, 10, 13.5, 17], "borderColor": "#4299e1", "backgroundColor": "rgba(66,153,225,0.15)", "tension": 0.4, "fill": true}]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { color: 'rgba(255,255,255,0.05)' } }
            }
                    }
                });
            }
        });
        </script>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>CAPM operates on the principle that investors should not be compensated for 'idiosyncratic risk'—risks specific to a single company that can be eliminated by owning a diverse basket of stocks. Instead, it focuses on 'systematic risk,' which is the unavoidable volatility of the entire market. The model defines an asset's expected return as the sum of the risk-free rate and a risk premium. This premium is calculated by multiplying the asset's Beta (its sensitivity to market movements) by the equity risk premium (the extra return the market offers over a safe investment). Essentially, if an asset is twice as sensitive to market crashes as the average stock, the model dictates you should require twice the market's typical risk premium to hold it.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>A fundamental equilibrium model that describes the relationship between systematic risk and expected return for assets, particularly stocks.</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Imagine a risk-free Treasury bond pays 2% and the overall stock market is expected to return 8%. If you are looking at a high-tech stock with a Beta of 1.5, it is 50% more volatile than the market. Using CAPM, your required return is 2% + 1.5 * (8% - 2%), which equals 11%. If the stock is only projected to return 9%, CAPM suggests it is not a good investment because the reward doesn't compensate for its market risk.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Students often wrongly assume that a stock with high individual volatility always has a high Beta. In reality, a stock can swing wildly due to its own internal issues (high total risk), but if those swings don't correlate with the broader market, its Beta will remain low.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> According to the Capital Asset Pricing Model (CAPM), investors are only compensated for which type of risk?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Unsystematic risk
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Systematic risk
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Diversifiable risk
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Company-specific risk
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! CAPM assumes that unsystematic risk can be diversified away, meaning the market only provides a return premium for non-diversifiable systematic risk.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. CAPM assumes that unsystematic risk can be diversified away, meaning the market only provides a return premium for non-diversifiable systematic risk.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> Which component of the CAPM formula measures the sensitivity of an asset's returns relative to the returns of the entire market?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Alpha
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Risk-free rate
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Standard deviation
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Beta
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Beta is the specific metric in the CAPM that quantifies an asset's systematic risk by comparing its price volatility to the broader market.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Beta is the specific metric in the CAPM that quantifies an asset's systematic risk by comparing its price volatility to the broader market.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> In the CAPM formula, what does the term (Rm - Rf) represent?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        The expected return on the asset
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The risk-free rate of return
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        The market risk premium
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The asset's total risk
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The market risk premium represents the additional return an investor expects to receive for choosing a risky market portfolio over a risk-free investment.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The market risk premium represents the additional return an investor expects to receive for choosing a risky market portfolio over a risk-free investment.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-5" class="concept-section">
            <h2>Alpha and Beta</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Beta is like a kite in the wind; it rises and falls based on how strong the general breeze is blowing. Alpha is like adding a small motor to that kite, allowing it to climb even higher than the wind alone would lift it.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>These metrics allow investors to distinguish between 'luck' (simply riding market trends) and 'skill' (active stock picking). They help determine if a fund manager truly adds value or if they are just taking on more risk to make returns look higher.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="comparison-block">
            <div class="comparison-side left">
                <h4>🔵 Beta (Market Sensitivity)</h4>
                <ul><li>Represents 'Systematic Risk' (the tide)</li><li>Measures volatility relative to the benchmark</li><li>A Beta of 1.0 means the asset moves with the market</li><li>Expected return for taking on market exposure</li></ul>
            </div>
            <div class="comparison-divider">vs</div>
            <div class="comparison-side right">
                <h4>🟢 Alpha (Excess Return)</h4>
                <ul><li>Represents 'Idiosyncratic Return' (the motor)</li><li>Measures value added by specific selection</li><li>Positive Alpha means beating the risk-adjusted trend</li><li>The 'holy grail' of active investing and skill</li></ul>
            </div>
        </div>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Beta measures the 'systematic' relationship between an asset and the broader market; it is a multiplier that tells you how much the asset will react to a 1% move in the benchmark. If an asset has a Beta of 1.5, it is expected to swing 1.5% for every 1% the market moves, representing the risk you cannot diversify away. Alpha is the 'idiosyncratic' return, or the portion of performance that is independent of the market's movement. In an efficient market, Alpha should be zero because assets are priced perfectly for their risk; therefore, a positive Alpha suggests a mispricing or a unique advantage that provided 'excess' return beyond what the Beta would predict.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>Beta represents an asset's sensitivity to market movements (systematic risk), while Alpha represents the excess return or mispricing relative to the market benchmark.</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>If the market returns 10% and your stock has a Beta of 1.2, you would 'expect' a 12% return based on risk alone. If your stock actually returns 15%, that extra 3% is the Alpha. Conversely, if the stock only returns 10% despite its higher risk, it has a negative Alpha of -2%, meaning it underperformed its risk-adjusted benchmark.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Students often mistake high total returns for high Alpha, forgetting that a portfolio might only be 'winning' because it has a high Beta during a bull market. If the market crashes, that high-Beta portfolio will crash much harder, revealing that there was no true Alpha (skill) protecting the gains.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> If a stock has a Beta of 1.5, how is it expected to react if the market benchmark rises by 10%?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        The stock is expected to decrease by 15%.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The stock is expected to increase by 10%.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        The stock is expected to increase by 15%.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The stock is expected to remain unchanged regardless of the market.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! A Beta of 1.5 indicates the asset is 50% more sensitive to market movements than the benchmark, resulting in a 15% gain when the market rises 10%.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. A Beta of 1.5 indicates the asset is 50% more sensitive to market movements than the benchmark, resulting in a 15% gain when the market rises 10%.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> Which of the following best describes a portfolio with a positive Alpha?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="true">
                        The portfolio's returns are higher than what would be predicted by its Beta and market performance.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The portfolio is perfectly correlated with the market index movements.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The portfolio has high systematic risk and will always lose money in a bear market.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The portfolio's returns are solely derived from broad market growth.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Alpha represents the excess return of an investment relative to the return of a benchmark index, often viewed as a measure of a manager's skill or asset mispricing.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Alpha represents the excess return of an investment relative to the return of a benchmark index, often viewed as a measure of a manager's skill or asset mispricing.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> An investor seeking to minimize exposure to systematic market fluctuations should look for an asset with:
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        A high positive Alpha
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        A Beta close to zero
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        A Beta significantly higher than 1.0
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        A negative Alpha
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Beta measures sensitivity to market movements, so a Beta close to zero indicates the asset has little to no systematic risk relative to the market.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Beta measures sensitivity to market movements, so a Beta close to zero indicates the asset has little to no systematic risk relative to the market.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-6" class="concept-section">
            <h2>Risk Premium</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Think of the risk premium as 'hazard pay' for a dangerous job. A window cleaner on a skyscraper earns more than a janitor on the ground floor, not because they work more hours, but because they are willing to accept the physical risk that others avoid.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>It helps investors distinguish between earning money through skill (arbitrage) versus earning money simply by being a 'risk-bearer.' Understanding this prevents investors from being blindsided by losses, as it confirms that higher potential returns always come with a higher chance of failure.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="chart-container">
            <div class="chart-title">Components of Expected Return by Asset Class</div>
            <canvas id="chart-6" style="max-height:380px;"></canvas>
            <div class="chart-caption">Total return is the sum of the risk-free rate and the premium paid for taking specific risks.</div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('chart-6');
            if (ctx && typeof Chart !== 'undefined') {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ["Cash (Risk-Free)", "Govt Bonds", "Corporate Bonds", "S&P 500 Stocks", "Venture Capital"],
                        datasets: [{"label": "Risk-Free Rate (%)", "data": [3, 3, 3, 3, 3], "borderColor": "#f6c177", "backgroundColor": "#cbd5e0"}, {"label": "Risk Premium (%)", "data": [0, 1, 2.5, 5.5, 12], "borderColor": "#a3d9a5", "backgroundColor": "#4299e1"}]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { color: 'rgba(255,255,255,0.05)' } }
            }
                    }
                });
            }
        });
        </script>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>In a functional market, prices are mostly efficient, meaning you cannot easily 'outsmart' the system. Instead, the primary way to earn higher returns is to provide the service of bearing uncertainty. Because most people are risk-averse, they demand an extra incentive to hold volatile assets like stocks rather than safe ones like government bonds. This 'extra' expected return above the risk-free rate is the risk premium. It is the market's price for your willingness to endure the possibility of losing your principal investment.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>•  Mis-Pricing: market could be inefficient at 5% of the time and 5% of the
assets. Leading to a small room of arbitrage.

•  Risk Premium: Market is still quite efficient, but you earn additional risk
premium by taking exposure on certain type of risks. Leading to earn risk premiums when exposed to certain type of risks.

•  You can diversify the risks by allocating your bets on different market.
Diversification is probably the only free lunch in the financial market. 6


[Tables on this page: </div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>If a US Treasury bond pays a guaranteed 3% (the risk-free rate) and the stock market is expected to return 8% over the same period, the Equity Risk Premium is 5%. An investor putting $10,000 into stocks is effectively being paid $500 extra per year to tolerate the 'rollercoaster' of market volatility. If the market didn't offer this 5% premium, everyone would stay in the safe bond, and no one would fund companies.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Students often mistake the risk premium for a 'guaranteed' bonus, forgetting that it is only an 'expected' return. If the premium didn't involve a real risk of losing money, it wouldn't exist, as everyone would rush to buy the asset until the price rose and the premium vanished.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> According to the provided text, how is a risk premium primarily earned in a market that remains relatively efficient?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        By identifying mis-pricing 95% of the time
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        By taking exposure on certain types of risks
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        By avoiding all forms of market risk
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        By eliminating the need for diversification
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text states that in an efficient market, risk premiums are earned when an investor is exposed to certain specific types of risks.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text states that in an efficient market, risk premiums are earned when an investor is exposed to certain specific types of risks.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> Based on the concept of 'Mis-Pricing,' to what extent can arbitrage opportunities typically be found?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Across 50% of all available market assets
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        During 95% of market operating hours
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Only within a small room of 5% of the time and 5% of assets
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Arbitrage is impossible because the market is 100% efficient
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The content specifies that the market may be inefficient only 5% of the time and for 5% of assets, leading to a small room for arbitrage.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The content specifies that the market may be inefficient only 5% of the time and for 5% of assets, leading to a small room for arbitrage.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> What does the text describe as 'probably the only free lunch in the financial market'?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="true">
                        Diversification
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Arbitrage
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Mis-pricing
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Risk exposure
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text explicitly refers to diversification as the only free lunch because it allows investors to reduce risk by allocating bets across different markets.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text explicitly refers to diversification as the only free lunch because it allows investors to reduce risk by allocating bets across different markets.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-7" class="concept-section">
            <h2>Diversification</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Imagine you own two small businesses: one that sells umbrellas and one that sells sunscreen. On a rainy day, your umbrella sales soar while sunscreen fails, and on a sunny day, the opposite happens, ensuring you have a steady stream of cash regardless of the weather.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>With over 30,000 stocks globally, it is impossible to predict which single company might face a unique disaster like a lawsuit or a fire. Diversification allows you to eliminate these 'company-specific' risks, leaving you exposed only to the broader market movements that actually pay a risk premium.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="chart-container">
            <div class="chart-title">The Power of Diversification: Risk vs. Number of Assets</div>
            <canvas id="chart-7" style="max-height:380px;"></canvas>
            <div class="chart-caption">As the number of stocks increases, total risk (volatility) drops toward the level of Systematic Market Risk.</div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('chart-7');
            if (ctx && typeof Chart !== 'undefined') {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ["1", "5", "10", "20", "30", "40", "50+"],
                        datasets: [{"label": "Total Portfolio Risk", "data": [45, 28, 22, 18, 16, 15, 14.5], "borderColor": "#4299e1", "backgroundColor": "rgba(66,153,225,0.15)", "tension": 0.4, "fill": true}]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { color: 'rgba(255,255,255,0.05)' } }
            }
                    }
                });
            }
        });
        </script>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>Diversification is the mathematical process of combining assets that do not move in perfect lockstep—meaning they have a correlation of less than 1.0. When you add more non-correlated assets to a portfolio, the unique, random fluctuations of individual stocks (idiosyncratic risk) tend to average out toward zero. This results in a reduction of the overall portfolio's volatility without a proportional decrease in expected return. Consequently, it is called the 'only free lunch' because it improves the risk-adjusted return (Sharpe Ratio), allowing you to achieve the same gain with significantly less 'heartache' or price swinging.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>premium by taking exposure on certain type of risks. Leading to earn risk premiums when exposed to certain type of risks.

•  You can diversify the risks by allocating your bets on different market.
Diversification is probably the only free lunch in the financial market. 6


[Tables on this page: 1]

============================================================
PAGE 8
============================================================

Basic Concepts of Returns and Risks</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>If you put $10,000 into a single tech startup, a single bad product launch could wipe out your entire investment. If you instead put $100 into 100 different startups across tech, healthcare, and energy, it becomes statistically improbable that all 100 will fail simultaneously. Even if five companies go bankrupt, the steady growth of the other 95 protects your principal and allows you to capture the sector's overall upward trend.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Many investors confuse quantity with diversification by owning 20 different stocks that are all in the same sector, such as AI and technology. Because these companies all react identically to interest rate changes or chip shortages, the portfolio remains highly vulnerable to a single industry-wide crash.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> Why is diversification famously referred to as the 'only free lunch' in the financial market?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        It guarantees that an investor will never lose money in any market condition.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        It allows for the reduction of risk without necessarily reducing expected returns.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It provides investors with access to markets without paying any transaction fees.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        It eliminates the need to take on any type of risk premiums.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Diversification is considered a 'free lunch' because it can lower overall portfolio risk without a proportional sacrifice in potential returns.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Diversification is considered a 'free lunch' because it can lower overall portfolio risk without a proportional sacrifice in potential returns.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> According to the content, how can an investor achieve diversification of their risks?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        By concentrating all capital into the single most profitable market.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        By avoiding all types of risk exposure to prevent losses.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        By allocating their 'bets' or investments across different markets.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        By only investing in assets that do not offer risk premiums.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The text states that you can diversify risks by allocating your bets across different markets rather than focusing on just one.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The text states that you can diversify risks by allocating your bets across different markets rather than focusing on just one.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> What is the primary result of taking on exposure to certain types of risks as described in the text?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="true">
                        Leading to the earning of risk premiums.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The immediate elimination of market volatility.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        A guaranteed fixed return regardless of market performance.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        The ability to trade without any capital requirements.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! The content specifies that being exposed to certain types of risks allows an investor to earn risk premiums as a reward for that exposure.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. The content specifies that being exposed to certain types of risks allows an investor to earn risk premiums as a reward for that exposure.
                    </div>
                </div>
                
        </section>
        
        <section id="concept-8" class="concept-section">
            <h2>Idiosyncratic vs. Systematic Risk</h2>
            
            <!-- Simple Analogy -->
            <div class="feynman-block" style="border-left-color: var(--accent-primary);">
                <h4>Simple Analogy</h4>
                <p>Systematic risk is like a massive regional drought that affects every farmer in the valley, regardless of what they plant. Idiosyncratic risk is like a single farmer's tractor breaking down; it’s a problem for that one farm, but it doesn't stop the neighbors from harvesting.</p>
            </div>
            
            <!-- Why It Matters -->
            <div class="feynman-block" style="border-left-color: var(--accent-secondary);">
                <h4>Why This Matters</h4>
                <p>This distinction is the foundation of modern portfolio theory because it proves that investors aren't compensated for taking risks they could easily avoid through diversification. Understanding this allows you to build portfolios that eliminate unnecessary company-specific 'noise' while focusing on the broader economic factors that actually drive long-term returns.</p>
            </div>
            
            <!-- Visualization -->
            
        <div class="chart-container">
            <div class="chart-title">Risk Reduction Through Diversification</div>
            <canvas id="chart-8" style="max-height:380px;"></canvas>
            <div class="chart-caption">As the number of stocks increases, Idiosyncratic risk is eliminated, but Systematic risk remains as a constant floor.</div>
        </div>
        <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('chart-8');
            if (ctx && typeof Chart !== 'undefined') {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ["1", "5", "10", "20", "30", "40", "50+"],
                        datasets: [{"label": "Total Portfolio Risk", "data": [40, 25, 18, 14, 12, 11, 10], "borderColor": "#4299e1", "backgroundColor": "rgba(66,153,225,0.15)", "tension": 0.4, "fill": true}, {"label": "Systematic Risk (Market Floor)", "data": [10, 10, 10, 10, 10, 10, 10], "borderColor": "#e53e3e", "backgroundColor": "transparent", "tension": 0.4, "fill": true}]
                    },
                    options: {
                        plugins: {
                            legend: { position: 'bottom' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                x: { grid: { color: 'rgba(255,255,255,0.05)' } }
            }
                    }
                });
            }
        });
        </script>
        
            
            <!-- Deep Explanation -->
            <div class="expandable">
                <div class="expandable-header">
                    <span>Deep Dive: Detailed Explanation</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>In financial modeling, total risk is the sum of market-wide fluctuations and company-specific events. Systematic risk (market risk) is driven by macroeconomic factors like interest rate changes, inflation, or geopolitical shifts that impact all assets simultaneously; because these forces move the entire 'ocean,' you cannot escape them just by owning more assets. Idiosyncratic risk (unsystematic risk) represents the unique hazards of a specific firm, such as a product recall or a management scandal. Because these events are statistically independent across different companies, as you add more unrelated assets to a portfolio, the random 'bad luck' of one is offset by the 'good luck' of another, eventually reducing the idiosyncratic component to nearly zero.</p>
                        <div style="margin-top: 1rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.95rem; color: var(--text-tertiary);"><strong>From lecture:</strong><br>Systematic risk is market-wide risk that cannot be diversified away, whereas idiosyncratic risk is specific to an individual asset and can be removed through a portfolio.</div>
                    </div>
                </div>
            </div>
            
            <!-- Practical Example -->
            <div class="expandable open">
                <div class="expandable-header">
                    <span>Practical Example</span>
                    <span class="expandable-icon">▼</span>
                </div>
                <div class="expandable-content">
                    <div class="expandable-content-inner">
                        <p>If you invest solely in Apple, you face the idiosyncratic risk of a glass shortage at their specific factories. If you diversify by buying a basket of 500 different stocks, that factory shortage won't hurt your total wealth because it's diluted by 499 other healthy companies. However, if the Federal Reserve suddenly doubles interest rates, almost every stock in your 500-company basket will drop; this is systematic risk that diversification cannot fix.</p>
                    </div>
                </div>
            </div>
            
            <!-- Common Mistakes -->
            <div class="feynman-block" style="border-left-color: var(--accent-warning);">
                <h4>Common Mistakes</h4>
                <p>Many students mistakenly believe that if they diversify enough, they can reach 'zero risk.' In reality, diversification only eliminates idiosyncratic risk, leaving you with a floor of systematic risk that remains no matter how many stocks you buy.</p>
            </div>
            
            <!-- Quiz Questions -->
            
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 1:</strong> Which of the following best describes the primary difference between systematic and idiosyncratic risk regarding diversification?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Systematic risk can be diversified away, while idiosyncratic risk cannot.
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Idiosyncratic risk can be eliminated through a well-diversified portfolio, while systematic risk remains.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Both types of risk can be completely eliminated by holding at least 10 stocks.
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Neither risk can be reduced through diversification.
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Idiosyncratic risk is unique to specific assets and averages out in a portfolio, whereas systematic risk affects the entire market and cannot be avoided through diversification.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Idiosyncratic risk is unique to specific assets and averages out in a portfolio, whereas systematic risk affects the entire market and cannot be avoided through diversification.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 2:</strong> An investor is worried about a sudden increase in nationwide interest rates affecting their entire portfolio. This is an example of:
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="false">
                        Idiosyncratic risk
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Specific risk
                    </div>
                    
                    <div class="quiz-option" data-correct="true">
                        Systematic risk
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        Diversifiable risk
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! Changes in interest rates are market-wide factors that affect all securities, making it a classic example of systematic risk.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. Changes in interest rates are market-wide factors that affect all securities, making it a classic example of systematic risk.
                    </div>
                </div>
                
                <div class="quiz-container">
                    <div class="quiz-question">
                        <strong>Question 3:</strong> Which of the following events would most likely be classified as idiosyncratic risk for a company?
                    </div>
                    <div class="quiz-options">
                        
                    <div class="quiz-option" data-correct="true">
                        A sudden explosion at a company's main manufacturing plant
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        A global pandemic causing a worldwide economic shutdown
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        An increase in the federal capital gains tax rate
                    </div>
                    
                    <div class="quiz-option" data-correct="false">
                        A surge in international oil prices affecting all transport sectors
                    </div>
                    
                    </div>
                    <div class="quiz-feedback correct">
                        ✓ Correct! A localized event like a factory explosion only affects that specific firm, meaning it is an asset-specific risk that does not impact the broader market.
                    </div>
                    <div class="quiz-feedback incorrect">
                        ✗ Not quite. A localized event like a factory explosion only affects that specific firm, meaning it is an asset-specific risk that does not impact the broader market.
                    </div>
                </div>
                
        </section>
        
            
            <!-- Completion -->
            <div style="margin-top: 4rem; padding: 2rem; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 12px; text-align: center; color: white;">
                <h3 style="margin-bottom: 1rem;">Course Complete!</h3>
                <p>You've reviewed all 8 main concepts. Keep practicing with the quizzes above.</p>
            </div>
        </main>

        <div class="column-resizer" id="resizerRight" role="separator" aria-orientation="vertical" aria-label="Resize right sidebar"></div>

        <!-- Right Sidebar: AI Assistant & Tools -->
        <aside class="sidebar-right">
            <div class="ai-chat">
                <div class="ai-chat-header">
                    <div>
                        <h3 style="margin: 0;">AI Study Assistant</h3>
                        <p style="font-size: 0.8rem; color: var(--text-tertiary); margin: 0;">Powered by Gemini</p>
                    </div>
                </div>
                
                <div class="ai-chat-messages" id="aiMessages">
                    <div class="ai-message assistant">
                        Hi! I'm your AI study assistant. Ask me anything about this topic, or request:
                        <ul style="margin-top: 0.5rem; padding-left: 1.5rem; font-size: 0.9rem;">
                            <li>Explanations in simpler terms</li>
                            <li>More examples</li>
                            <li>Practice questions</li>
                            <li>Connections to other concepts</li>
                        </ul>
                    </div>
                </div>
                
                <div class="ai-input-group">
                    <input 
                        type="text" 
                        class="ai-input" 
                        id="aiInput" 
                        placeholder="Ask a question..."
                        onkeypress="if(event.key==='Enter') sendAIMessage()"
                    />
                    <button class="ai-send-btn" onclick="sendAIMessage()">Send</button>
                </div>
            </div>

            <!-- Quick Actions -->
            <div style="margin-top: 2rem;">
                <h4 style="margin-bottom: 1rem; color: var(--text-tertiary);">Quick Actions</h4>
                <button onclick="reviewAllQuizzes()" class="action-btn">
                    Review All Quizzes
                </button>
                <button onclick="createSummary()" class="action-btn">
                    Generate Summary
                </button>
                <button onclick="window.print()" class="action-btn">
                    Print Notes
                </button>
            </div>
            
            <!-- Keyboard Shortcuts -->
            <div style="margin-top: 2rem; padding: 1rem; background: var(--bg-elevated); border-radius: 8px; font-size: 0.85rem;">
                <h5 style="margin-bottom: 0.75rem; color: var(--text-tertiary);">Shortcuts</h5>
                <div id="shortcutsDisplay" style="color: var(--text-secondary); line-height: 1.8;">
                    <div><kbd id="shortcutFocusAI">Alt+A</kbd> Focus AI</div>
                    <div><kbd id="shortcutSummary">Alt+S</kbd> Summary</div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        
        // ── Gemini Proxy Configuration ──
        const GEMINI_PROXY_URL = '../api/gemini';
        const LAYOUT_STORAGE_KEY = 'learning-layout-widths-v1';
        
        let courseContext = '';
        let conversationHistory = [];

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        
        // ── Main Controller ──
        class LearningPageController {
            constructor() {
                this.isMac = /Mac|iPhone|iPod|iPad/i.test(navigator.platform);
                this.setupExpandables();
                this.setupQuizzes();
                this.setupProgressTracking();
                this.setupScrollReveal();
                this.setupCourseContext();
                this.setupKeyboardShortcuts();
                this.initializeMermaid();
                this.initializeCharts();
                this.updateShortcutsDisplay();
                this.setupColumnResizers();
            }
            
            initializeMermaid() {
                if (typeof mermaid !== 'undefined') {
                    mermaid.initialize({
                        startOnLoad: true,
                        theme: 'dark',
                        themeVariables: {
                            primaryColor: '#263352',
                            primaryTextColor: '#edf2f7',
                            primaryBorderColor: '#f6c177',
                            lineColor: '#a0aec0',
                            secondaryColor: '#1f2b47',
                            tertiaryColor: '#1c2a45',
                            background: '#16213e',
                            mainBkg: '#263352',
                            nodeBorder: '#f6c177',
                            clusterBkg: '#1f2b47',
                            fontSize: '14px'
                        },
                        flowchart: { curve: 'basis', padding: 20 },
                        sequence: { actorMargin: 50 }
                    });
                }
            }
            
            initializeCharts() {
                if (typeof Chart !== 'undefined') {
                    Chart.defaults.color = '#a0aec0';
                    Chart.defaults.borderColor = 'rgba(255,255,255,0.06)';
                    Chart.defaults.font.family = "-apple-system, 'Helvetica Neue', sans-serif";
                    Chart.defaults.responsive = true;
                    Chart.defaults.maintainAspectRatio = true;
                    Chart.defaults.plugins.legend.labels.usePointStyle = true;
                }
            }
            
            setupCourseContext() {
                const mc = document.querySelector('.main-content');
                if (mc) courseContext = mc.innerText.substring(0, 6000);
            }
            
            setupExpandables() {
                document.querySelectorAll('.expandable-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.parentElement.classList.toggle('open');
                    });
                });
            }
            
            setupQuizzes() {
                document.querySelectorAll('.quiz-option').forEach(opt => {
                    opt.addEventListener('click', () => this.handleQuiz(opt));
                });
            }

            handleQuiz(option) {
                const quiz = option.closest('.quiz-container');
                const isCorrect = option.dataset.correct === 'true';
                
                quiz.querySelectorAll('.quiz-option').forEach(o => {
                    o.classList.remove('selected','correct','incorrect');
                });
                
                option.classList.add('selected');
                option.classList.add(isCorrect ? 'correct' : 'incorrect');
                
                if (!isCorrect) {
                    quiz.querySelectorAll('.quiz-option').forEach(o => {
                        if (o.dataset.correct === 'true') o.classList.add('correct');
                    });
                }
                
                const cf = quiz.querySelector('.quiz-feedback.correct');
                const ic = quiz.querySelector('.quiz-feedback.incorrect');
                if (isCorrect) { cf.classList.add('show'); ic.classList.remove('show'); }
                else { ic.classList.add('show'); cf.classList.remove('show'); }
            }

            
            setupProgressTracking() {
                window.addEventListener('scroll', () => {
                    const h = document.documentElement.scrollHeight - window.innerHeight;
                    const p = h > 0 ? Math.min((window.scrollY / h) * 100, 100) : 0;
                    document.getElementById('progressBar').style.width = p + '%';
                });
            }
            
            setupScrollReveal() {
                const obs = new IntersectionObserver((entries) => {
                    entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('revealed'); });
                }, { threshold: 0.08 });
                document.querySelectorAll('.reveal-on-scroll').forEach(el => obs.observe(el));
            }
            
            setupKeyboardShortcuts() {
                document.addEventListener('keydown', (e) => {
                    if (e.altKey && e.key === 'a') {
                        e.preventDefault();
                        document.getElementById('aiInput')?.focus();
                    }
                    if (e.altKey && e.key === 's') {
                        e.preventDefault();
                        askSummary();
                    }
                });
            }
            
            updateShortcutsDisplay() {
                const prefix = this.isMac ? '⌥' : 'Alt+';
                const focusEl = document.getElementById('shortcutFocusAI');
                const summaryEl = document.getElementById('shortcutSummary');
                if (focusEl) focusEl.textContent = prefix + 'A';
                if (summaryEl) summaryEl.textContent = prefix + 'S';
            }

            setupColumnResizers() {
                if (window.matchMedia('(max-width: 1200px)').matches) return;
                const container = document.querySelector('.page-container');
                const leftResizer = document.getElementById('resizerLeft');
                const rightResizer = document.getElementById('resizerRight');
                if (!container || !leftResizer || !rightResizer) return;

                const minLeft = 200, maxLeft = 560;
                const minRight = 220, maxRight = 560;
                const minMain = 520;
                let leftWidth = 260;
                let rightWidth = 300;

                const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
                const applyWidths = () => {
                    container.style.setProperty('--left-width', leftWidth + 'px');
                    container.style.setProperty('--right-width', rightWidth + 'px');
                };
                const getTotalWidth = () => container.getBoundingClientRect().width - 16;
                const clampAll = () => {
                    const total = getTotalWidth();
                    leftWidth = clamp(leftWidth, minLeft, maxLeft);
                    rightWidth = clamp(rightWidth, minRight, maxRight);
                    if (total - leftWidth - rightWidth < minMain) {
                        const overflow = minMain - (total - leftWidth - rightWidth);
                        leftWidth = clamp(leftWidth - overflow / 2, minLeft, maxLeft);
                        rightWidth = clamp(rightWidth - overflow / 2, minRight, maxRight);
                        if (total - leftWidth - rightWidth < minMain) {
                            const rightCap = clamp(total - leftWidth - minMain, minRight, maxRight);
                            rightWidth = rightCap;
                            leftWidth = clamp(total - rightWidth - minMain, minLeft, maxLeft);
                        }
                    }
                };

                try {
                    const cached = JSON.parse(localStorage.getItem(LAYOUT_STORAGE_KEY) || '{}');
                    if (Number.isFinite(cached.left)) leftWidth = cached.left;
                    if (Number.isFinite(cached.right)) rightWidth = cached.right;
                } catch {}
                clampAll();
                applyWidths();

                const startDrag = (side) => (evt) => {
                    evt.preventDefault();
                    const rect = container.getBoundingClientRect();
                    const total = getTotalWidth();
                    const onMove = (moveEvt) => {
                        if (side === 'left') {
                            const rawLeft = moveEvt.clientX - rect.left;
                            const maxAllowed = Math.min(maxLeft, total - rightWidth - minMain);
                            leftWidth = clamp(rawLeft, minLeft, Math.max(minLeft, maxAllowed));
                        } else {
                            const rawRight = rect.right - moveEvt.clientX;
                            const maxAllowed = Math.min(maxRight, total - leftWidth - minMain);
                            rightWidth = clamp(rawRight, minRight, Math.max(minRight, maxAllowed));
                        }
                        applyWidths();
                    };
                    const stopMove = () => {
                        document.body.style.userSelect = '';
                        document.body.style.cursor = '';
                        leftResizer.classList.remove('dragging');
                        rightResizer.classList.remove('dragging');
                        localStorage.setItem(LAYOUT_STORAGE_KEY, JSON.stringify({ left: leftWidth, right: rightWidth }));
                        document.removeEventListener('pointermove', onMove);
                        document.removeEventListener('pointerup', stopMove);
                    };
                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'col-resize';
                    (side === 'left' ? leftResizer : rightResizer).classList.add('dragging');
                    document.addEventListener('pointermove', onMove);
                    document.addEventListener('pointerup', stopMove);
                };

                leftResizer.addEventListener('pointerdown', startDrag('left'));
                rightResizer.addEventListener('pointerdown', startDrag('right'));
                window.addEventListener('resize', () => {
                    if (window.matchMedia('(max-width: 1200px)').matches) return;
                    clampAll();
                    applyWidths();
                });
            }
        }
        
        // ── AI Chat (Real Gemini API) ──
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            appendMsg('user', msg);
            input.value = '';
            input.disabled = true;
            
            const typingEl = appendMsg('assistant', '<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>');
            
            try {
                const answer = await callGemini(msg);
                typingEl.innerHTML = formatMd(answer);
            } catch (err) {
                const errMsg = err?.message || String(err);
                let hint = 'Check console for details.';
                if (window.location.protocol === 'file:' || errMsg.includes('Failed to fetch')) {
                    const current = window.location.pathname.split('/').pop();
                    hint = `Start local server: python3 serve.py --open html/${current} and ensure GEMINI_API_KEY exists in .env.local`;
                }
                typingEl.innerHTML = '⚠️ Error: ' + escapeHtml(errMsg) + '<br><small>' + escapeHtml(hint) + '</small>';
                console.error('Gemini API error:', err);
            } finally {
                input.disabled = false;
                input.focus();
            }
        }
        
        async function callGemini(userMessage) {
            if (window.location.protocol === 'file:') {
                throw new Error('This page is opened as file:// and cannot reach ../api/gemini');
            }

            const prompt = `You are a concise study assistant for this course.

Course content (excerpt):
${courseContext.substring(0, 3500)}

Previous conversation:
${conversationHistory.slice(-4).map(m => m.role + ': ' + m.content).join('\n')}

Student question: ${userMessage}

Instructions:
- Answer in 3-6 sentences, be direct and complete
- Always finish your sentences, never leave a thought incomplete
- Use the course content as reference
- If the question is in Chinese, answer in Chinese`;

            const res = await fetch(GEMINI_PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: prompt,
                    generationConfig: { temperature: 0.7, maxOutputTokens: 1024 }
                })
            });
            
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`API ${res.status}: ${errText.substring(0, 200)}`);
            }
            
            const data = await res.json();
            const candidate = data.candidates?.[0];
            const answer = candidate?.content?.parts?.[0]?.text;
            if (!answer) throw new Error('Empty response from API');
            
            // Check if response was truncated
            if (candidate?.finishReason === 'MAX_TOKENS') {
                conversationHistory.push({ role: 'user', content: userMessage }, { role: 'assistant', content: answer });
                return answer + '...\n\n_(Response was trimmed. Ask a follow-up for more detail.)_';
            }
            
            conversationHistory.push({ role: 'user', content: userMessage }, { role: 'assistant', content: answer });
            return answer;
        }
        
        function appendMsg(role, html) {
            const container = document.getElementById('aiMessages');
            const div = document.createElement('div');
            div.className = 'ai-message ' + role;
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }
        
        function formatMd(text) {
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code style="background:var(--bg-tertiary);padding:0.1em 0.4em;border-radius:3px;font-size:0.9em;">$1</code>')
                .replace(/\n/g, '<br>');
        }
        
        function askSummary() {
            const input = document.getElementById('aiInput');
            input.value = 'Please summarize the key concepts of this lesson in bullet points.';
            sendAIMessage();
        }
        
        function reviewAllQuizzes() {
            const q = document.querySelector('.quiz-container');
            if (q) q.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function createSummary() { askSummary(); }
        
        // ── Sidebar Tabs ──
        function switchSidebarTab(tabName) {
            document.querySelectorAll('.sidebar-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-panel').forEach(p => p.style.display = 'none');
            document.querySelector(`.sidebar-tab[data-tab="${tabName}"]`)?.classList.add('active');
            const panel = document.getElementById('panel-' + tabName);
            if (panel) panel.style.display = 'block';
        }
        
        // ── Notes System ──
        const NOTES_STORAGE_KEY = 'learning-notes-' + document.title;
        const NOTES_FOCUS_KEY = NOTES_STORAGE_KEY + '-focus';
        const NOTES_ACTIVE_KEY = NOTES_STORAGE_KEY + '-active';
        const NOTES_DRAFT_KEY = NOTES_STORAGE_KEY + '-draft';
        
        function loadNotes() {
            try {
                const raw = JSON.parse(localStorage.getItem(NOTES_STORAGE_KEY) || '[]');
                if (!Array.isArray(raw)) return [];
                return raw.map((n, idx) => {
                    const idNum = Number(n?.id);
                    return {
                        id: Number.isFinite(idNum) ? idNum : -(idx + 1),
                        citation: typeof n?.citation === 'string' ? n.citation : (typeof n?.quote === 'string' ? n.quote : ''),
                        body: typeof n?.body === 'string' ? n.body : (typeof n?.text === 'string' ? n.text : (typeof n?.content === 'string' ? n.content : '')),
                        section: typeof n?.section === 'string' ? n.section : (typeof n?.title === 'string' ? n.title : ''),
                        timestamp: typeof n?.timestamp === 'string' && n.timestamp
                            ? n.timestamp
                            : (typeof n?.created_at === 'string' && n.created_at ? n.created_at : new Date().toISOString())
                    };
                });
            }
            catch { return []; }
        }
        
        function saveNotes(notes) {
            localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(notes));
            renderNotes();
        }

        function saveDraft(text) {
            localStorage.setItem(NOTES_DRAFT_KEY, text || '');
        }

        function loadDraft() {
            return localStorage.getItem(NOTES_DRAFT_KEY) || '';
        }

        function renderDraftPreview(text) {
            const preview = document.getElementById('noteDraftPreviewContent');
            if (!preview) return;
            const clean = text || '';
            if (!clean.trim()) {
                preview.innerHTML = '<span style="color: var(--text-tertiary);">Type in the note box to preview Markdown rendering in real time.</span>';
                return;
            }
            preview.innerHTML = renderNoteMarkdown(clean);
        }

        function handleNoteInputChange(value) {
            saveDraft(value);
            renderDraftPreview(value);
        }

        function initNoteComposer() {
            const input = document.getElementById('noteInput');
            if (!input) return;
            const draft = loadDraft();
            input.value = draft;
            renderDraftPreview(draft);
            input.addEventListener('input', () => {
                handleNoteInputChange(input.value);
            });
            input.addEventListener('keydown', (e) => {
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    addFreeNote();
                }
            });
        }

        function getFocusedNoteId() {
            const value = localStorage.getItem(NOTES_FOCUS_KEY);
            return value ? Number(value) : null;
        }

        function getActiveNoteId() {
            const value = localStorage.getItem(NOTES_ACTIVE_KEY);
            return value ? Number(value) : null;
        }

        function setFocusedNoteId(id) {
            if (!id) localStorage.removeItem(NOTES_FOCUS_KEY);
            else localStorage.setItem(NOTES_FOCUS_KEY, String(id));
        }

        function setActiveNoteId(id) {
            if (!id) localStorage.removeItem(NOTES_ACTIVE_KEY);
            else localStorage.setItem(NOTES_ACTIVE_KEY, String(id));
        }

        function toggleFocusNote(id, e) {
            e?.stopPropagation();
            const focusedId = getFocusedNoteId();
            setFocusedNoteId(focusedId === id ? null : id);
            renderNotes();
        }

        function openNote(id) {
            setActiveNoteId(id);
            renderNotes();
            switchSidebarTab('notes');
        }

        function ensureNoteReader() {
            const panel = document.getElementById('panel-notes');
            const notesList = document.getElementById('notesList');
            if (!panel || !notesList) return null;
            notesList.style.maxHeight = '32vh';

            let reader = document.getElementById('noteReader');
            if (!reader) {
                reader = document.createElement('div');
                reader.id = 'noteReader';
                reader.className = 'note-reader';
                notesList.insertAdjacentElement('afterend', reader);
            }
            return reader;
        }

        function renderNoteMarkdown(text) {
            return escapeHtml(text || '')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`(.+?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
        }

        function renderNoteReader(notes) {
            const reader = ensureNoteReader();
            if (!reader) return;
            if (notes.length === 0) {
                reader.innerHTML = '<div class="reader-title">Reader</div><div class="reader-content">No notes yet.</div>';
                return;
            }

            let activeId = getActiveNoteId();
            let active = notes.find(n => n.id === activeId);
            if (!active) {
                active = notes[0];
                setActiveNoteId(active.id);
            }
            const time = new Date(active.timestamp).toLocaleString();
            const citationHtml = active.citation ? `<div class="note-citation">${escapeHtml(active.citation)}</div>` : '';
            const activeBody = typeof active.body === 'string' ? active.body : '';
            reader.innerHTML = `
                <div class="reader-title">Reading • ${escapeHtml(active.section || 'General')} • ${time}</div>
                ${citationHtml}
                <div class="reader-content">${renderNoteMarkdown(activeBody)}</div>
            `;
        }
        
        function addNote(citation, body, section) {
            const notes = loadNotes();
            const note = {
                id: Date.now(),
                citation: citation || '',
                body: body || '',
                section: section || '',
                timestamp: new Date().toISOString()
            };
            notes.push(note);
            setActiveNoteId(note.id);
            saveNotes(notes);
            // Switch to notes tab
            switchSidebarTab('notes');
        }
        
        function addFreeNote() {
            const input = document.getElementById('noteInput');
            const text = input.value.trim();
            if (!text) return;
            addNote('', text, '');
            input.value = '';
            saveDraft('');
            renderDraftPreview('');
        }
        
        function deleteNote(id, e) {
            e?.stopPropagation();
            const notes = loadNotes().filter(n => n.id !== id);
            if (getFocusedNoteId() === id) setFocusedNoteId(null);
            if (getActiveNoteId() === id) setActiveNoteId(notes.length ? notes[0].id : null);
            saveNotes(notes);
        }
        
        function renderNotes() {
            const notes = loadNotes();
            const container = document.getElementById('notesList');
            const counter = document.getElementById('notesCount');
            if (!container) return;
            
            counter.textContent = notes.length + ' note' + (notes.length !== 1 ? 's' : '');
            
            if (notes.length === 0) {
                container.innerHTML = '<p style="font-size:0.85rem; color:var(--text-tertiary); text-align:center; padding:2rem 0;">Select text and click "Add Note" to begin, or write freely below.</p>';
                renderNoteReader(notes);
                return;
            }

            const focusedId = getFocusedNoteId();
            const activeId = getActiveNoteId();
            const sortedNotes = [...notes].sort((a, b) => {
                const aFocused = a.id === focusedId ? 1 : 0;
                const bFocused = b.id === focusedId ? 1 : 0;
                if (aFocused !== bFocused) return bFocused - aFocused;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            container.innerHTML = sortedNotes.map(n => {
                const time = new Date(n.timestamp).toLocaleString();
                const citationHtml = n.citation 
                    ? `<div class="note-citation">${escapeHtml(n.citation)}</div>` 
                    : '';
                const noteBody = typeof n.body === 'string' ? n.body : '';
                const preview = noteBody.length > 140 ? (noteBody.slice(0, 140) + '...') : noteBody;
                const focusLabel = n.id === focusedId ? 'Unfocus' : 'Focus';
                return `<div class="note-card ${n.id === activeId ? 'active' : ''} ${n.id === focusedId ? 'focused' : ''}" onclick="openNote(${n.id})">
                    ${citationHtml}
                    <div class="note-body">${escapeHtml(preview)}</div>
                    <div class="note-meta">
                        <span>${n.section ? escapeHtml(n.section) : ''} ${time}</span>
                        <span>
                            <button class="note-focus" onclick="toggleFocusNote(${n.id}, event)">${focusLabel}</button>
                            <button class="note-delete" onclick="deleteNote(${n.id}, event)">Delete</button>
                        </span>
                    </div>
                </div>`;
            }).join('');
            renderNoteReader(sortedNotes);
        }
        
        function exportNotesToObsidian() {
            const notes = loadNotes();
            if (notes.length === 0) { alert('No notes to export.'); return; }
            
            const title = document.title.replace(' - Interactive Learning', '');
            const sourceFile = document.querySelector('.main-content header p')?.textContent?.match(/Source: (.+)/)?.[1] || '';
            
            let md = `---
tags: [lecture-notes, mfin7034]
source: "${sourceFile}"
date: ${new Date().toISOString().split('T')[0]}
---

`;
            md += `# ${title}

`;
            md += `> [!info] Source
> PDF: [[${sourceFile.replace('.pdf','')}]]

`;
            
            notes.forEach((n, idx) => {
                if (n.citation) {
                    md += `> [!quote] Highlight
> ${n.citation}

`;
                }
                const noteBody = typeof n.body === 'string' ? n.body : '';
                md += noteBody + `

`;
                if (idx < notes.length - 1) md += `---

`;
            });
            
            md += `
## References

- Source: ${sourceFile}
- Generated: ${new Date().toLocaleString()}
`;
            
            const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = title.replace(/[^a-zA-Z0-9一-鿿 ]/g, '_') + '.md';
            a.click();
            URL.revokeObjectURL(a.href);
        }
        
        // ── Text Highlight & Selection ──
        const highlightTooltip = document.createElement('div');
        highlightTooltip.className = 'highlight-tooltip';
        highlightTooltip.innerHTML = `
            <button onclick="highlightSelection()">Highlight</button>
            <button onclick="highlightAndNote()">+ Note</button>
        `;
        document.body.appendChild(highlightTooltip);
        
        document.addEventListener('mouseup', (e) => {
            const sel = window.getSelection();
            const text = sel.toString().trim();
            
            // Only show for selections within main content
            const main = document.querySelector('.main-content');
            if (!text || text.length < 3 || !main?.contains(sel.anchorNode)) {
                highlightTooltip.classList.remove('show');
                return;
            }
            
            const range = sel.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            highlightTooltip.style.left = rect.left + (rect.width / 2) - 60 + 'px';
            highlightTooltip.style.top = rect.top - 40 + window.scrollY + 'px';
            highlightTooltip.classList.add('show');
        });
        
        document.addEventListener('mousedown', (e) => {
            if (!highlightTooltip.contains(e.target)) {
                highlightTooltip.classList.remove('show');
            }
        });
        
        function highlightSelection() {
            const sel = window.getSelection();
            if (!sel.rangeCount) return;
            const range = sel.getRangeAt(0);
            const mark = document.createElement('mark');
            mark.className = 'text-highlight';
            try {
                range.surroundContents(mark);
            } catch(e) {
                // Cross-element selection: fall back
                const text = sel.toString();
                mark.textContent = text;
                range.deleteContents();
                range.insertNode(mark);
            }
            sel.removeAllRanges();
            highlightTooltip.classList.remove('show');
        }
        
        function highlightAndNote() {
            const sel = window.getSelection();
            const text = sel.toString().trim();
            if (!text) return;
            
            // Find section context
            let section = '';
            let node = sel.anchorNode;
            while (node && node !== document.body) {
                if (node.classList?.contains('concept-section')) {
                    const h2 = node.querySelector('h2');
                    if (h2) section = h2.textContent;
                    break;
                }
                node = node.parentNode;
            }
            
            highlightSelection();
            
            openInlineSelectionNoteEditor(text, section, sel.getRangeAt(0).getBoundingClientRect());
        }
        

        function closeInlineSelectionNoteEditor() {
            document.getElementById('inlineSelectionNoteEditor')?.remove();
        }

        function openInlineSelectionNoteEditor(selectionText, section, rect) {
            closeInlineSelectionNoteEditor();
            const editor = document.createElement('div');
            editor.id = 'inlineSelectionNoteEditor';
            editor.style.position = 'absolute';
            editor.style.zIndex = '10030';
            editor.style.width = 'min(420px, 90vw)';
            editor.style.background = 'var(--bg-card)';
            editor.style.border = '1px solid var(--border-color)';
            editor.style.borderRadius = '12px';
            editor.style.boxShadow = '0 16px 36px rgba(0,0,0,0.32)';
            editor.style.padding = '0.65rem';
            editor.style.top = (window.scrollY + rect.bottom + 10) + 'px';
            editor.style.left = Math.max(12, Math.min(window.scrollX + rect.left, window.scrollX + window.innerWidth - 440)) + 'px';
            editor.innerHTML = `
                <div style="font-size:0.78rem;color:var(--text-tertiary);margin-bottom:0.4rem;">Add note for selection</div>
                <textarea id="inlineSelectionNoteInput" placeholder="Write note... (Markdown supported)" style="width:100%;min-height:88px;background:var(--bg-primary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:8px;padding:0.5rem;font-size:0.86rem;resize:vertical;"></textarea>
                <div style="display:flex;justify-content:flex-end;gap:0.45rem;margin-top:0.45rem;">
                    <button type="button" id="inlineSelectionNoteCancel" style="border:1px solid var(--border-color);background:var(--bg-elevated);color:var(--text-primary);border-radius:8px;padding:0.3rem 0.6rem;cursor:pointer;font-size:0.8rem;">Cancel</button>
                    <button type="button" id="inlineSelectionNoteSave" style="border:1px solid rgba(163,217,165,.55);background:var(--bg-elevated);color:var(--accent-secondary);border-radius:8px;padding:0.3rem 0.6rem;cursor:pointer;font-size:0.8rem;">Save</button>
                </div>
            `;
            document.body.appendChild(editor);
            const input = editor.querySelector('#inlineSelectionNoteInput');
            input?.focus();
            editor.querySelector('#inlineSelectionNoteCancel')?.addEventListener('click', closeInlineSelectionNoteEditor);
            editor.querySelector('#inlineSelectionNoteSave')?.addEventListener('click', () => {
                const body = (input?.value || '').trim() || '(highlighted)';
                addNote(selectionText, body, section);
                closeInlineSelectionNoteEditor();
            });
        }

        // ── Init ──
        document.addEventListener('DOMContentLoaded', () => {
            new LearningPageController();
            
            // Add reveal animation to concept sections
            document.querySelectorAll('.feynman-block, .quiz-container, .expandable, .chart-container, .diagram-container, .comparison-block, .stats-grid').forEach(el => {
                el.classList.add('reveal-on-scroll');
            });
            
            // Re-init observer for dynamically added elements
            const obs = new IntersectionObserver((entries) => {
                entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('revealed'); });
            }, { threshold: 0.08 });
            document.querySelectorAll('.reveal-on-scroll').forEach(el => obs.observe(el));
            
            // Initialize note draft autosave + live markdown preview
            initNoteComposer();
            // Load saved notes
            renderNotes();
        });
        
        // Typing dots animation
        const typingStyle = document.createElement('style');
        typingStyle.textContent = `
            .typing-dots span {
                animation: blink 1.4s infinite;
                font-size: 1.5em;
                line-height: 1;
            }
            .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
            .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
            @keyframes blink {
                0%, 60%, 100% { opacity: 0.2; }
                30% { opacity: 1; }
            }
        `;
        document.head.appendChild(typingStyle);
    
    </script>
    
    <!-- KaTeX auto-render -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false},
                        {left: "\\(", right: "\\)", display: false},
                        {left: "\\[", right: "\\]", display: true}
                    ],
                    throwOnError: false
                });
            }
        });
    </script>
    <script src="./app-shell.js?v=10"></script>
    <script src="./lecture-enhancements.js?v=4"></script>
</body>
</html>